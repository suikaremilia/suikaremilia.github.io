<!DOCTYPE html>
<html lang="en-us" class="scroll-smooth">
    <head><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Opne Shift 4.6在线安装</title>
<meta name="description" content="OCP是个好东西，除了贵">
<link rel="canonical" href="https://suikaremilia.github.io/posts/opneshift-46-install.md/">
<link rel="robots" href="/robots.txt" />
<link rel="stylesheet" href="https://suikaremilia.github.io/css/main.min.df1b948651de2b50af2bded0966d2d08b2a7217f36cbc0e2aaaaa9a7d2a94144.css" integrity="sha256-3xuUhlHeK1CvK97Qlm0tCLKnIX82y8Diqqqpp9KpQUQ=">
</head>
    <body class="max-w-screen-md px-10 mx-auto"><header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
    

<figure class="flex-none w-20 h-20 rounded-full overflow-hidden" ><a href="https://suikaremilia.github.io/"><img srcset="/img/firefox_hub66cb162f84e73856336c19b5d2d497e_36921_80x80_fill_q90_box_smart1.jpg 80w" src="/img/firefox.jpg" width="640" height="640" alt="Red Panda YOLO"></a></figure>

    <div class="flex flex-col gap-5">
    <a href="https://suikaremilia.github.io/">
    
    <h3 class="text-center sm:text-left text-4xl font-extrabold text-gray-800 ">Red Panda YOLO</h3>
    
</a>
    <nav>
    <ul class="flex flex-wrap justify-center uppercase text-xs font-semibold gap-7 text-gray-500 ">
        
        
        <li class="hover:text-gray-500"><a href="/">Home</a></li>
        
        <li class="hover:text-gray-500"><a href="/posts">Posts</a></li>
        
        <li class="hover:text-gray-500"><a href="/murmur">Ｍurmur</a></li>
        
        <li class="hover:text-gray-500"><a href="/tags">Tags</a></li>
        
    </ul>
</nav>
    </div>
</header><div id="content">
<article class="flex flex-col gap-10">
    <header class="flex flex-col gap-2">
        <h2 class="text-4xl leading-snug font-bold text-gray-900">Opne Shift 4.6在线安装</h2>

        <div class="text-sm font-semibold text-gray-500 flex gap-3">
        
<time datetime="2020-12-12 09:14:40 &#43;0000 UTC" title="2020-12-12 09:14:40 &#43;0000 UTC">
    12 December 2020
</time>
        
        —
        
            <a class="hover:text-gray-500" href="/categories/tech/" alt="Tech" >
                Tech
                </a>
        

        </div>
    </header>
    <section class="content text-lg text-gray-800">
    <h2 id="规划">规划</h2>
<h3 id="架构">架构：</h3>
<h3 id="服务器信息">服务器信息：</h3>
<table>
<thead>
<tr>
<th>用途</th>
<th>主机名</th>
<th>IP</th>
</tr>
</thead>
<tbody>
<tr>
<td>Master1</td>
<td>ocpmaster01.suika.com</td>
<td>10.90.16.21</td>
</tr>
<tr>
<td>Work1</td>
<td>ocpwork01.suika.com</td>
<td>10.90.16.22</td>
</tr>
<tr>
<td>Work2</td>
<td>ocpwork02.suika.com</td>
<td>10.90.16.23</td>
</tr>
<tr>
<td>bootstrap</td>
<td>bootstrap.ocpsuika.com</td>
<td>10.90.18.19</td>
</tr>
<tr>
<td>bastion</td>
<td>bastion.suika.com</td>
<td>10.90.18.16</td>
</tr>
</tbody>
</table>
<h3 id="域名信息">域名信息：</h3>
<table>
<thead>
<tr>
<th>用途</th>
<th>域名</th>
<th>地址</th>
<th>端口</th>
</tr>
</thead>
<tbody>
<tr>
<td>Kubernetes API</td>
<td>api.ocp.suika.com</td>
<td>10.90.18.19</td>
<td>6443</td>
</tr>
<tr>
<td>Kubernetes API</td>
<td>api-int.suika.com</td>
<td>10.90.18.19</td>
<td>443</td>
</tr>
<tr>
<td>Routes</td>
<td>*.apps.suika.com</td>
<td>10.90.18.19</td>
<td>443</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>域名</th>
<th>IP</th>
<th>端口</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>console-openshift-console.apps.ocp.suika.com</td>
<td>10.90.16.21</td>
<td>443</td>
<td>OCP控制台页面</td>
</tr>
<tr>
<td>oauth-openshift.apps.ocp.suika.com</td>
<td>10.90.16.21</td>
<td>443</td>
<td>OCP oauth登录跳转页面</td>
</tr>
<tr>
<td>prometheus-k8s-openshift-monitoring.apps.ocp.suika.com</td>
<td>10.90.16.21</td>
<td>443</td>
<td>Prometheus</td>
</tr>
<tr>
<td>kibana-openshift-logging.apps.ocp.suika.com</td>
<td>10.90.16.21</td>
<td>443</td>
<td>Kibana</td>
</tr>
<tr>
<td>api.ocp.suika.com</td>
<td>10.90.16.21</td>
<td>6443</td>
<td>API</td>
</tr>
</tbody>
</table>
<h3 id="端口列表">端口列表：</h3>
<table>
<thead>
<tr>
<th>协议</th>
<th>端口</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>TCP</td>
<td>2379-2380</td>
<td>etcd server, peer, and metrics ports</td>
</tr>
<tr>
<td>TCP</td>
<td>6443</td>
<td>Kubernetes API</td>
</tr>
<tr>
<td>TCP</td>
<td>10249-10259</td>
<td>The default ports that Kubernetes reserves</td>
</tr>
<tr>
<td>TCP</td>
<td>10256</td>
<td>openshift-sdn</td>
</tr>
<tr>
<td>TCP</td>
<td>9000-9999</td>
<td>Host level services, including the node exporter on ports 9100-9101 and the Cluster Version Operator on port 9099.</td>
</tr>
<tr>
<td>UDP</td>
<td>4789、6081</td>
<td>VXLAN and GENEVE</td>
</tr>
<tr>
<td>UDP</td>
<td>9000-9999</td>
<td>Host level services, including the node exporter on ports 9100-9101.</td>
</tr>
<tr>
<td>TCP/UDP</td>
<td>30000-32767</td>
<td>Kubernetes NodePort</td>
</tr>
</tbody>
</table>
<h2 id="环境准备">环境准备：</h2>
<h3 id="离线资源">离线资源：</h3>
<p>pull secret <a href="https://cloud.redhat.com/openshift/install/metal/installer-provisioned">下载地址</a><br>
OpenShift CLI（OC）<a href="https://access.redhat.com/downloads/content/290/ver=4.6/rhel---8/4.6.3/x86_64/product-software">下载地址</a><br>
Openshift-install CLI <a href="https://access.redhat.com/downloads/content/290/ver=4.6/rhel---8/4.6.3/x86_64/product-software">下载地址</a><br>
CoreOS image <a href="https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/4.6/4.6.1/">下载地址</a></p>
<h3 id="安装openshift-cli并创建目录">安装OpenShift CLI并创建目录：</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#080;font-style:italic"># tar xvzf oc-4.6.3-linux.tar.gz</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"># tar xvzf openshift-install-linux-4.6.3.tar.gz</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"># mv oc kubectl openshift-install /usr/local/bin</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"># mkdir -p /opt/install</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"># touch /opt/install/install-config.yaml</span>
</span></span></code></pre></div><h3 id="dns配置">DNS配置：</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#666">[</span>root@bastion ~<span style="color:#666">]</span><span style="color:#080;font-style:italic"># yum install dnsmasq -y</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#666">[</span>root@bastion ~<span style="color:#666">]</span><span style="color:#080;font-style:italic"># cat /etc/dnsmasq.d/ocp.conf </span>
</span></span><span style="display:flex;"><span><span style="color:#b8860b">address</span><span style="color:#666">=</span>/bastion.suika.com/10.90.18.16
</span></span><span style="display:flex;"><span><span style="color:#b8860b">address</span><span style="color:#666">=</span>/api.ocp.suika.com/10.90.18.16
</span></span><span style="display:flex;"><span><span style="color:#b8860b">address</span><span style="color:#666">=</span>/.apps.ocp.suika.com/10.90.18.16
</span></span><span style="display:flex;"><span><span style="color:#b8860b">address</span><span style="color:#666">=</span>/api-int.ocp.suika.com/10.90.18.16
</span></span><span style="display:flex;"><span><span style="color:#b8860b">address</span><span style="color:#666">=</span>/ocpmaster01.ocp.suika.com/10.90.16.21
</span></span><span style="display:flex;"><span><span style="color:#b8860b">address</span><span style="color:#666">=</span>/ocpmaster02.ocp.suika.com/10.90.16.22
</span></span><span style="display:flex;"><span><span style="color:#b8860b">address</span><span style="color:#666">=</span>/ocpmaster03.ocp.suika.com/10.90.16.23
</span></span><span style="display:flex;"><span><span style="color:#b8860b">address</span><span style="color:#666">=</span>/bootstrap.ocp.suika.com/10.19.18.19
</span></span><span style="display:flex;"><span><span style="color:#b8860b">address</span><span style="color:#666">=</span>/registry.suika.com/10.90.18.9
</span></span><span style="display:flex;"><span><span style="color:#b8860b">address</span><span style="color:#666">=</span>/oauth-openshift.ocp.suika.com/10.90.18.16
</span></span><span style="display:flex;"><span>ptr-record<span style="color:#666">=</span>21.16.90.10.in-addr.arpa,ocpmaster01.ocp.suika.com
</span></span><span style="display:flex;"><span>ptr-record<span style="color:#666">=</span>22.16.90.10.in-addr.arpa,ocpmaster02.ocp.suika.com
</span></span><span style="display:flex;"><span>ptr-record<span style="color:#666">=</span>23.16.90.10.in-addr.arpa,ocpmaster03.ocp.suika.com
</span></span><span style="display:flex;"><span>ptr-record<span style="color:#666">=</span>19.18.90.10.in-addr.arpa,bootstrap.ocp.suika.com
</span></span><span style="display:flex;"><span>srv-host<span style="color:#666">=</span>_etcd-server-ssl._tcp.ocp.suika.com,etcd-0.ocp.suika.com,2380,10
</span></span><span style="display:flex;"><span>srv-host<span style="color:#666">=</span>_etcd-server-ssl._tcp.ocp.suika.com,etcd-1.ocp.suika.com,2380,10
</span></span><span style="display:flex;"><span>srv-host<span style="color:#666">=</span>_etcd-server-ssl._tcp.ocp.suika.com,etcd-2.ocp.suika.com,2380,10
</span></span></code></pre></div><p>启动服务：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#666">[</span>root@bastion ~<span style="color:#666">]</span><span style="color:#080;font-style:italic"># systemctl start dnsmasq.service</span>
</span></span><span style="display:flex;"><span><span style="color:#666">[</span>root@bastion ~<span style="color:#666">]</span><span style="color:#080;font-style:italic"># systemctl status dnsmasq.service </span>
</span></span><span style="display:flex;"><span>● dnsmasq.service - DNS caching server.
</span></span><span style="display:flex;"><span>   Loaded: loaded <span style="color:#666">(</span>/usr/lib/systemd/system/dnsmasq.service; enabled; vendor preset: disabled<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>   Active: active <span style="color:#666">(</span>running<span style="color:#666">)</span> since Fri 2020-12-11 23:03:19 CST; <span style="color:#666">2</span> weeks <span style="color:#666">3</span> days ago
</span></span><span style="display:flex;"><span> Main PID: <span style="color:#666">46638</span> <span style="color:#666">(</span>dnsmasq<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>   CGroup: /system.slice/dnsmasq.service
</span></span><span style="display:flex;"><span>           └─46638 /usr/sbin/dnsmasq -k
</span></span></code></pre></div><h3 id="配置haproxy">配置haproxy：</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#666">[</span>root@bastion ~<span style="color:#666">]</span><span style="color:#080;font-style:italic"># yum install haproxy -y</span>
</span></span><span style="display:flex;"><span><span style="color:#666">[</span>root@bastion ~<span style="color:#666">]</span><span style="color:#080;font-style:italic"># vim /etc/haproxy/haproxy.cfg</span>
</span></span><span style="display:flex;"><span>global
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    log         127.0.0.1 local2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    chroot      /var/lib/haproxy
</span></span><span style="display:flex;"><span>    pidfile     /var/run/haproxy.pid
</span></span><span style="display:flex;"><span>    maxconn     <span style="color:#666">4000</span>
</span></span><span style="display:flex;"><span>    user        haproxy
</span></span><span style="display:flex;"><span>    group       haproxy
</span></span><span style="display:flex;"><span>    daemon
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic"># turn on stats unix socket</span>
</span></span><span style="display:flex;"><span>    stats socket /var/lib/haproxy/stats
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">#---------------------------------------------------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"># common defaults that all the &#39;listen&#39; and &#39;backend&#39; sections will</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"># use if not designated in their block</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">#---------------------------------------------------------------------</span>
</span></span><span style="display:flex;"><span>defaults
</span></span><span style="display:flex;"><span>    mode                    http
</span></span><span style="display:flex;"><span>    log                     global
</span></span><span style="display:flex;"><span>    option                  httplog
</span></span><span style="display:flex;"><span>    option                  dontlognull
</span></span><span style="display:flex;"><span>    option http-server-close
</span></span><span style="display:flex;"><span>    option forwardfor       except 127.0.0.0/8
</span></span><span style="display:flex;"><span>    option                  redispatch
</span></span><span style="display:flex;"><span>    retries                 <span style="color:#666">3</span>
</span></span><span style="display:flex;"><span>    timeout http-request    10s
</span></span><span style="display:flex;"><span>    timeout queue           1m
</span></span><span style="display:flex;"><span>    timeout connect         10s
</span></span><span style="display:flex;"><span>    timeout client          1m
</span></span><span style="display:flex;"><span>    timeout server          1m
</span></span><span style="display:flex;"><span>    timeout http-keep-alive 10s
</span></span><span style="display:flex;"><span>    timeout check           10s
</span></span><span style="display:flex;"><span>    maxconn                 <span style="color:#666">3000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>listen stats
</span></span><span style="display:flex;"><span>    <span style="color:#a2f">bind</span> :9000
</span></span><span style="display:flex;"><span>    mode http
</span></span><span style="display:flex;"><span>    stats <span style="color:#a2f">enable</span>
</span></span><span style="display:flex;"><span>    stats uri /
</span></span><span style="display:flex;"><span>    monitor-uri /healthz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>frontend openshift-api-server
</span></span><span style="display:flex;"><span>    <span style="color:#a2f">bind</span> *:6443
</span></span><span style="display:flex;"><span>    default_backend openshift-api-server
</span></span><span style="display:flex;"><span>    mode tcp
</span></span><span style="display:flex;"><span>    option tcplog
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>backend openshift-api-server
</span></span><span style="display:flex;"><span>    balance <span style="color:#a2f">source</span>
</span></span><span style="display:flex;"><span>    mode tcp
</span></span><span style="display:flex;"><span>    server bootstrap 10.90.18.19:6443 check
</span></span><span style="display:flex;"><span>    server master-0 10.90.16.21:6443 check
</span></span><span style="display:flex;"><span>    server master-1 10.90.16.22:6443 check
</span></span><span style="display:flex;"><span>    server master-2 10.90.16.23:6443 check
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>frontend machine-config-server
</span></span><span style="display:flex;"><span>    <span style="color:#a2f">bind</span> *:22623
</span></span><span style="display:flex;"><span>    default_backend machine-config-server
</span></span><span style="display:flex;"><span>    mode tcp
</span></span><span style="display:flex;"><span>    option tcplog
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>backend machine-config-server
</span></span><span style="display:flex;"><span>    balance <span style="color:#a2f">source</span>
</span></span><span style="display:flex;"><span>    mode tcp
</span></span><span style="display:flex;"><span>    server bootstrap 10.90.18.19:22623 check
</span></span><span style="display:flex;"><span>    server master-0 10.90.16.21:22623 check
</span></span><span style="display:flex;"><span>    server master-0 10.90.16.22:22623 check
</span></span><span style="display:flex;"><span>    server master-0 10.90.16.23:22623 check
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>frontend ingress-http
</span></span><span style="display:flex;"><span>    <span style="color:#a2f">bind</span> *:80
</span></span><span style="display:flex;"><span>    default_backend ingress-http
</span></span><span style="display:flex;"><span>    mode tcp
</span></span><span style="display:flex;"><span>    option tcplog
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>backend ingress-http
</span></span><span style="display:flex;"><span>    balance <span style="color:#a2f">source</span>
</span></span><span style="display:flex;"><span>    mode tcp
</span></span><span style="display:flex;"><span>    server worker-1 10.90.16.22:80 check
</span></span><span style="display:flex;"><span>    server worker-2 10.90.16.23:80 check
</span></span><span style="display:flex;"><span>    server worker-3 10.90.16.21:80 check
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>frontend ingress-https
</span></span><span style="display:flex;"><span>    <span style="color:#a2f">bind</span> *:443
</span></span><span style="display:flex;"><span>    default_backend ingress-https
</span></span><span style="display:flex;"><span>    mode tcp
</span></span><span style="display:flex;"><span>    option tcplog
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>backend ingress-https
</span></span><span style="display:flex;"><span>    balance <span style="color:#a2f">source</span>
</span></span><span style="display:flex;"><span>    mode tcp
</span></span><span style="display:flex;"><span>    server worker-1 10.90.16.22:443 check
</span></span><span style="display:flex;"><span>    server worker-2 10.90.16.23:443 check
</span></span><span style="display:flex;"><span>    server worker-3 10.90.16.21:443 check
</span></span><span style="display:flex;"><span>	
</span></span></code></pre></div><p>查看服务状态：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@bastion ~]# systemctl start haproxy.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[root@bastion ~]# systemctl status haproxy.service 
</span></span><span style="display:flex;"><span>● haproxy.service - HAProxy Load Balancer
</span></span><span style="display:flex;"><span>   Loaded: loaded (/usr/lib/systemd/system/haproxy.service; enabled; vendor preset: disabled)
</span></span><span style="display:flex;"><span>   Active: active (running) since Fri 2020-12-11 22:55:58 CST; 2 weeks 3 days ago
</span></span><span style="display:flex;"><span> Main PID: 46295 (haproxy-systemd)
</span></span><span style="display:flex;"><span>   CGroup: /system.slice/haproxy.service
</span></span><span style="display:flex;"><span>           ├─46295 /usr/sbin/haproxy-systemd-wrapper -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid
</span></span><span style="display:flex;"><span>           ├─46296 /usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid -Ds
</span></span><span style="display:flex;"><span>           └─46297 /usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid -Ds
</span></span></code></pre></div><h3 id="配置http服务器">配置http服务器：</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@bastion ~]# yum install httpd -y
</span></span><span style="display:flex;"><span>[root@bastion ~]# mkdir -p /var/www/html/install/
</span></span><span style="display:flex;"><span>[root@bastion ~]# ln -s /opt/install/ /var/www/html/install
</span></span></code></pre></div><p>同样启动服务并检查状态：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@bastion ~]# systemctl start httpd.service；systemctl status httpd.service
</span></span></code></pre></div><h2 id="安装过程">安装过程：</h2>
<h3 id="生成密钥待用">生成密钥待用：</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span> ssh-keygen -t rsa -b 2048 -N &#34;&#34; -f /root/.ssh/id_rsa ；cat /root/.ssh/id_rsa.pub 
</span></span></code></pre></div><h3 id="编辑install文件">编辑install文件：</h3>
<p>把下载的pull-secret.txt及上面的文件加到默认的install-config.yaml后面，并且配置proxy<br>
注意：noproxy中按“，”分隔</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>[root@bastion ~]# cat /opt/install-config.yaml <span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">baseDomain</span>:<span style="color:#bbb"> </span>suika.com <span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">proxy</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">httpProxy</span>:<span style="color:#bbb"> </span>http://suika:suika@proxy@suika.com:8080 <span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">noProxy</span>:<span style="color:#bbb"> </span>.suika.com,.suika.com,.ocp.suika.com,10.90.16.0/22<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">compute</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>- <span style="color:#008000;font-weight:bold">hyperthreading</span>:<span style="color:#bbb"> </span>Enabled   <span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">name</span>:<span style="color:#bbb"> </span>worker<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">0</span><span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">controlPlane</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">hyperthreading</span>:<span style="color:#bbb"> </span>Enabled   <span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">name</span>:<span style="color:#bbb"> </span>master <span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">3</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">name</span>:<span style="color:#bbb"> </span>ocp<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">networking</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">clusterNetwork</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>- <span style="color:#008000;font-weight:bold">cidr</span>:<span style="color:#bbb"> </span><span style="color:#666">10.128.0.0</span>/14 <span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">hostPrefix</span>:<span style="color:#bbb"> </span><span style="color:#666">23</span><span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">networkType</span>:<span style="color:#bbb"> </span>OpenShiftSDN<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">serviceNetwork</span>:<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>- <span style="color:#666">172.30.0.0</span>/16<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">platform</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">none</span>:<span style="color:#bbb"> </span>{}<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">fips</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">false</span><span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">pullSecret</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;{&#34;auths&#34;:{&#34;cloud.openshift.com&#34;:{&#34;auth&#34;:&#34;b3BlbnNoaWZ0LXJlbGVhc2UtZGV2K2N1aXNvbmd0YW9oM2Njb20xdnY2YjdzZ3FodWxyYjBiYXhucThxbW51b2s6WUYyQ1I1UTNNV1NFU1dLVVNEME8zNUo4UkVRUjI3QVBURDVIUkVWRVpEUExRSUJFOE85U0dFWE81QlRQNVo2VQ==&#34;,&#34;email&#34;:&#34;suika@suika.com&#34;},&#34;quay.io&#34;:{&#34;auth&#34;:&#34;b3BlbnNoaWZ0LXJlbGVhc2UtZGV2K2N1aXNvbmd0YW9oM2Njb20xdnY2YjdzZ3FodWxyYjBiYXhucThxbW51b2s6WUYyQ1I1UTNNV1NFU1dLVVNEME8zNUo4UkVRUjI3QVBURDVIUkVWRVpEUExRSUJFOE85U0dFWE81QlRQNVo2VQ==&#34;,&#34;email&#34;:&#34;suika@suika.com&#34;},&#34;registry.connect.redhat.com&#34;:{&#34;auth&#34;:&#34;NzYxMDE1Mnx1aGMtMVZWNmI3c0dxaFVMcmIwYkF4blE4cU1OVU9LOmV5SmhiR2NpT2lKU1V6VXhNaUo5LmV5SnpkV0lpT2lJMU1tWTROR05tWm1Nd01EQTBOelV5WVdVNU16WmxaVGhrTkROaFlUbGhNeUo5LlJiT1g3Ml9qY21fVTZLSFdVMS1VT19YTUk0aXVuSXZ3SVRWa1dsUDZ2QlU0Qzl0U2pickltM1FuY2Q4WENjeUVoQWY5cUoxVXRtWHlVWk5JODZ3dEo1eVE1STZnU3FlZ2RBMEZ2ek1tQk9qUzZ6eHAxVm83ZmNfVG1oYzBQSERhSWVudlhTZ3BscnNaUWpRckllVUNlUlNuaGRGdDFSdHU0djFaMDh1V1N4Y3k4VGI0dXIyNmRXZWhUSUF6Q0R2aFNkRzBhUVZaRExOYVd5QTE2YjIwSEdFYVNRNmlXUDNQZ05tUWFmTkdyUnNOTFZYd01Qd0ZQU01YMkdsVGhmMXludEpiTXl3UEx1a3pzaEozeFJ3bkFFV0JIdGd2dVlDNUN2YjB1SFlUMDJWVUV1Q21hbDBBQkppUlo4LVdiOV9RZEgxcXNKQzBGRGFUa2dhSjhzSWpleE9qTWtRWVZCeHI4OGpNNVcta0xlbmhLQmRxMTladHFiWTdwMGd0S0JjWjFQczlkSWJRRzJKSTVUZEZza2suika1VDeHdYM1o2QVlBeGJyR2ItSHVBRi1PT0pTdVBKU3RNMDJPblBHdGVRaUVSd0ZOMUZNZjEwRmxjQktlRTIyUGR1SU1sN3gyWTIxalJMR3VZdHBZa0FWVUZ1UEdMM3l3ZVFsWGk4RWYxVG9FV2kwU0dpWXFaNEt1ZWNLVjhUWFhWNHJCUTJSNHhZQmVwZ1F5d2xPNWdiU0xNQ0IwNzkxUlAtRXFyUlNadkJhbERjSlRfbzNxNlk5VWYtYnRuaVBjeTY0bkIxUHZmakxwazNqY0tBdWtBVHZDZjhrUmJKRVkwOFVWQXVpZENadFZiZDByWXpXNS1TUDN3VC10ZGhTb2h5OWNvZ2xTWkZ6aXhlYmJFdkNmalBJ&#34;,&#34;email&#34;:&#34;suika@suika.com&#34;},&#34;registry.redhat.io&#34;:{&#34;auth&#34;:&#34;NzYxMDE1Mnx1aGMtMVZWNmI3c0dxaFVMcmIwYkF4blE4cU1OVU9LOmV5SmhiR2NpT2lKU1V6VXhNaUo5LmV5SnpkV0lpT2lJMU1tWTROR05tWm1Nd01EQTBOelV5WVdVNU16WmxaVGhrTkROaFlUbGhNeUo5LlJiT1g3Ml9qY21fVTZLSFdVMS1VT19YTUk0aXVuSXZ3SVRWa1dsUDZ2QlU0Qzl0U2pickltM1FuY2Q4WENjeUVoQWY5cUoxVXRtWHlVWk5JODZ3dEo1eVE1STZnU3FlZ2RBMEZ2ek1tQk9qUzZ6eHAxVm83ZmNfVG1oYzBQSERhSWVudlhTZ3BscnNaUWpRckllVUNlUlNuaGRGdDFSdHU0djFaMDh1V1N4Y3k4VGI0dXIyNmRXZWhUSUF6Q0R2aFNkRzBhUVZaRExOYVd5QTE2YjIwSEdFYVNRNmlXUDNQZ05tUWFmTkdyUnNOTFZYd01Qd0ZQU01YMkdsVGhmMXludEpiTXl3UEx1a3pzaEozeFJ3bkFFV0JIdGd2dVlDNUN2YjB1SFlUMDJWVUV1Q21hbDBBQkppUlo4LVdiOV9RZEgxcXNKQzBGRGFUa2dhSjhzSWpleE9qTWtRWVZCeHI4OGpNNVcta0xlbmhLQmRxMTladHFiWTdwMGd0S0JjWjFQczlkSWJRRzJKSTVUZEZza2suika1VDeHdYM1o2QVlBeGJyR2ItSHVBRi1PT0pTdVBKU3RNMDJPblBHdGVRaUVSd0ZOMUZNZjEwRmxjQktlRTIyUGR1SU1sN3gyWTIxalJMR3VZdHBZa0FWVUZ1UEdMM3l3ZVFsWGk4RWYxVG9FV2kwU0dpWXFaNEt1ZWNLVjhUWFhWNHJCUTJSNHhZQmVwZ1F5d2xPNWdiU0xNQ0IwNzkxUlAtRXFyUlNadkJhbERjSlRfbzNxNlk5VWYtYnRuaVBjeTY0bkIxUHZmakxwazNqY0tBdWtBVHZDZjhrUmJKRVkwOFVWQXVpZENadFZiZDByWXpXNS1TUDN3VC10ZGhTb2h5OWNvZ2xTWkZ6aXhlYmJFdkNmalBJ&#34;,&#34;email&#34;:&#34;suika@suika.com&#34;}}}&#39;</span><span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">sshKey</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDnfEBthXuNhuE/3dnGHEfzB9I2aYVmJUMe25sxL9BsX02tj+OA4H30j30tB4hD+AWrP3PEnt8zdD25ggGu1lGE4Ckt38uhMYud/a+amr5oTcIfIYlj/f9mo8VwKzehx7K7G8JWnFXwPjln97MuM/QVg6S+DY2wvGCSG+6MFwrq4/OCBlu1qjyoaE6yMl510n3rOB1WrUcj/LCiHBTsCsytx4fmtbSLxUxMyl3nfA83zhATg+meHKFtLpIEGZbMib7diI8APcOlEX4lOOwqf0lI6bFfTy2pRJ2cLAJXLvQaJL4eOhTOMqzbquj3g+gzkqpMf2R9L/fDTP5pwQqIkJjd root@bastion&#39;</span><span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>[root@bastion ~]# cp /opt/install-config.yaml /opt/install/install-config.yaml <span style="color:#bbb">
</span></span></span></code></pre></div><h3 id="创建配置">创建配置：</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#666">[</span>root@bastion ~<span style="color:#666">]</span><span style="color:#080;font-style:italic"># openshift-install create manifests --dir=/opt/install</span>
</span></span><span style="display:flex;"><span>INFO Consuming Install Config from target directory 
</span></span><span style="display:flex;"><span>WARNING Making control-plane schedulable by setting MastersSchedulable to <span style="color:#a2f">true</span> <span style="color:#a2f;font-weight:bold">for</span> Scheduler cluster settings 
</span></span><span style="display:flex;"><span>INFO Manifests created in: /opt/install/manifests and /opt/install/openshift 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#666">[</span>root@bastion ~<span style="color:#666">]</span><span style="color:#080;font-style:italic"># openshift-install create ignition-configs --dir=/opt/install/</span>
</span></span><span style="display:flex;"><span>INFO Consuming Common Manifests from target directory 
</span></span><span style="display:flex;"><span>INFO Consuming Master Machines from target directory 
</span></span><span style="display:flex;"><span>INFO Consuming OpenShift Install <span style="color:#666">(</span>Manifests<span style="color:#666">)</span> from target directory 
</span></span><span style="display:flex;"><span>INFO Consuming Openshift Manifests from target directory 
</span></span><span style="display:flex;"><span>INFO Consuming Worker Machines from target directory 
</span></span><span style="display:flex;"><span>INFO Ignition-Configs created in: /opt/install and /opt/install/auth
</span></span></code></pre></div><p>现在的目录结构是这样：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@bastion ~]# tree /opt/install
</span></span><span style="display:flex;"><span>/opt/install
</span></span><span style="display:flex;"><span>├── auth
</span></span><span style="display:flex;"><span>│   ├── kubeadmin-password
</span></span><span style="display:flex;"><span>│   └── kubeconfig
</span></span><span style="display:flex;"><span>├── bootstrap.ign
</span></span><span style="display:flex;"><span>├── bootstrap.sh
</span></span><span style="display:flex;"><span>├── master.ign
</span></span><span style="display:flex;"><span>├── master.sh
</span></span><span style="display:flex;"><span>├── metadata.json
</span></span><span style="display:flex;"><span>└── worker.ign
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>1 directory, 8 files
</span></span></code></pre></div><h3 id="创建安装脚本">创建安装脚本：</h3>
<p>环境比较特殊，不能搭DHCP所以无法pxe安装，只能配置静态IP，又懒得改镜像，所以就琢磨出这么个办法安装。<br>
注意脚本中的<code>'rd.neednet=1'</code>否则启动的时候有可能主机名变为localhost</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#666">[</span>root@bastion ~<span style="color:#666">]</span><span style="color:#080;font-style:italic"># cat /var/www/html/install/bootstrap.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">#!/bin/bash</span>
</span></span><span style="display:flex;"><span>/bin/coreos-installer install --copy-network --insecure-ignition --ignition-url<span style="color:#666">=</span>http://10.90.18.16:8080/install/bootstrap.ign --firstboot-args <span style="color:#b44">&#39;rd.neednet=1&#39;</span> /dev/vda
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#666">[</span>root@bastion ~<span style="color:#666">]</span><span style="color:#080;font-style:italic"># cat /var/www/html/install/master.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">#!/bin/bash</span>
</span></span><span style="display:flex;"><span>/bin/coreos-installer install --copy-network --insecure-ignition --ignition-url<span style="color:#666">=</span>http://10.90.18.16:8080/install/master.ign --firstboot-args <span style="color:#b44">&#39;rd.neednet=1&#39;</span> /dev/sda
</span></span></code></pre></div><h3 id="启动设备">启动设备：</h3>
<p>打开设备电源并在ilo挂载rhcos镜像：<br>
<img src="1609291406688.png" alt=""><br>
<img src="1609291424913.png" alt=""><br>
<img src="1609291432187.png" alt=""><br>
用nmtui配置网络，生效后检查是否获取到主机名<br>
下载上面的安装脚本进行安装：<br>
<img src="1609291401163.png" alt=""></p>
<h3 id="重启设备进行安装">重启设备进行安装：</h3>
<p>安装完成后先重启bootstrap，待其重启完成后，并检查有pod后重启三台master主机。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#666">[</span>core@bootstrap ~<span style="color:#666">]</span>$ sudo crictl pods
</span></span><span style="display:flex;"><span>POD ID              CREATED              STATE               NAME                                                           NAMESPACE                             ATTEMPT
</span></span><span style="display:flex;"><span>519ca2107ede7       <span style="color:#666">33</span> seconds ago       Ready               bootstrap-kube-scheduler-bootstrap.ocp.suika.com             kube-system                           <span style="color:#666">0</span>
</span></span><span style="display:flex;"><span>ee3682d35720d       <span style="color:#666">33</span> seconds ago       Ready               bootstrap-kube-controller-manager-bootstrap.ocp.suika.com    kube-system                           <span style="color:#666">0</span>
</span></span><span style="display:flex;"><span>4832d0632a339       <span style="color:#666">33</span> seconds ago       Ready               bootstrap-kube-apiserver-bootstrap.ocp.suika.com             kube-system                           <span style="color:#666">0</span>
</span></span><span style="display:flex;"><span>1e6aa212b904d       <span style="color:#666">33</span> seconds ago       Ready               cloud-credential-operator-bootstrap.ocp.suika.com            openshift-cloud-credential-operator   <span style="color:#666">0</span>
</span></span><span style="display:flex;"><span>4fc5ec6c6e443       <span style="color:#666">33</span> seconds ago       Ready               bootstrap-cluster-version-operator-bootstrap.ocp.suika.com   openshift-cluster-version             <span style="color:#666">0</span>
</span></span><span style="display:flex;"><span>fee62b862de12       <span style="color:#666">50</span> seconds ago       Ready               bootstrap-machine-config-operator-bootstrap.ocp.suika.com    default                               <span style="color:#666">0</span>
</span></span><span style="display:flex;"><span>f7b83eedcfbc6       About a minute ago   Ready               etcd-bootstrap-member-bootstrap.ocp.suika.com                openshift-etcd                        <span style="color:#666">0</span>
</span></span><span style="display:flex;"><span><span style="color:#666">[</span>core@bootstrap ~<span style="color:#666">]</span>$ ss -tulnp|grep <span style="color:#666">6443</span>
</span></span><span style="display:flex;"><span>tcp     LISTEN   <span style="color:#666">0</span>        <span style="color:#666">128</span>                    *:6443                 *:*     
</span></span><span style="display:flex;"><span><span style="color:#666">[</span>core@bootstrap ~<span style="color:#666">]</span>$ ss -tulnp|grep <span style="color:#666">22623</span>
</span></span><span style="display:flex;"><span>tcp     LISTEN   <span style="color:#666">0</span>        <span style="color:#666">128</span>                    *:22623                *:*   
</span></span></code></pre></div><p>重启master的时候需要盯着点ilo，启动完成后虽然可以获取到正确的主机名，但还是要把主机名修改一下，不然后面再重启主机名可能又变回localhost了。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>[root<span style="color:#666">@</span>bastion<span style="color:#bbb"> </span><span style="color:#666">~</span>]<span style="color:#080;font-style:italic"># ssh core@10.90.16.23
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>The<span style="color:#bbb"> </span>authenticity<span style="color:#bbb"> </span>of<span style="color:#bbb"> </span>host<span style="color:#bbb"> </span><span style="color:#b44">&#39;10.90.16.23 (10.90.16.23)&#39;</span><span style="color:#bbb"> </span>can<span style="color:#b44">&#39;t be established.
</span></span></span><span style="display:flex;"><span><span style="color:#b44">ECDSA key fingerprint is SHA256:9ZehCh3XkLlk86xu43DiSnIk8bT14UfPGc+dlxX6qzg.
</span></span></span><span style="display:flex;"><span><span style="color:#b44">ECDSA key fingerprint is MD5:a7:d7:2c:58:5d:8c:42:44:ec:fa:b0:b8:76:86:7f:14.
</span></span></span><span style="display:flex;"><span><span style="color:#b44">Are you sure you want to continue connecting (yes/no)? yes
</span></span></span><span style="display:flex;"><span><span style="color:#b44">Warning: Permanently added &#39;</span><span style="color:#666">10</span>.<span style="color:#666">90</span>.<span style="color:#666">16</span>.<span style="color:#666">23</span><span style="color:#b44">&#39; (ECDSA) to the list of known hosts.
</span></span></span><span style="display:flex;"><span><span style="color:#b44">Red Hat Enterprise Linux CoreOS 46.82.202010091720-0
</span></span></span><span style="display:flex;"><span><span style="color:#b44">  Part of OpenShift 4.6, RHCOS is a Kubernetes native operating system
</span></span></span><span style="display:flex;"><span><span style="color:#b44">  managed by the Machine Config Operator (`clusteroperator/machine-config`).
</span></span></span><span style="display:flex;"><span><span style="color:#b44">
</span></span></span><span style="display:flex;"><span><span style="color:#b44">WARNING: Direct SSH access to machines is not recommended; instead,
</span></span></span><span style="display:flex;"><span><span style="color:#b44">make configuration changes via `machineconfig` objects:
</span></span></span><span style="display:flex;"><span><span style="color:#b44">  https://docs.openshift.com/container-platform/4.6/architecture/architecture-rhcos.html
</span></span></span><span style="display:flex;"><span><span style="color:#b44">
</span></span></span><span style="display:flex;"><span><span style="color:#b44">---
</span></span></span><span style="display:flex;"><span><span style="color:#b44">[core@ocpmaster03 ~]$ hostname
</span></span></span><span style="display:flex;"><span><span style="color:#b44">ocpmaster03.ocp.suika.com
</span></span></span><span style="display:flex;"><span><span style="color:#b44">[core@ocpmaster03 ~]$ sudo hostnamectl set-hostname ocpmaster03.ocp.suika.com
</span></span></span></code></pre></div><h3 id="等待安装完成">等待安装完成：</h3>
<p>此后剩下的就是等待安装完成，大概要一杯咖啡的时间：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@bastion ~]# openshift-install --dir=/opt/install wait-for bootstrap-complete --log-level=debug
</span></span><span style="display:flex;"><span>DEBUG OpenShift Installer 4.6.4                    
</span></span><span style="display:flex;"><span>DEBUG Built from commit 6e02d049701437fa81521fe981405745a62c86c5 
</span></span><span style="display:flex;"><span>INFO Waiting up to 20m0s for the Kubernetes API at https://api.ocp.suika.com:6443... 
</span></span><span style="display:flex;"><span>INFO API v1.19.0+9f84db3 up                       
</span></span><span style="display:flex;"><span>INFO Waiting up to 30m0s for bootstrapping to complete... 
</span></span></code></pre></div><p>至此可以移除bootstrap节点，并把haproxy中关于bootstrap的信息注释掉，并重启haproxy，然后继续等待安装完成：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@bastion ~]# oc get node
</span></span><span style="display:flex;"><span>NAME                          STATUS   ROLES           AGE    VERSION
</span></span><span style="display:flex;"><span>ocpmaster01.ocp.suika.com   Ready    master,worker   2m     v1.19.0+9f84db3
</span></span><span style="display:flex;"><span>ocpmaster02.ocp.suika.com   Ready    master,worker   5m9s   v1.19.0+9f84db3
</span></span><span style="display:flex;"><span>ocpmaster03.ocp.suika.com   Ready    master,worker   10m    v1.19.0+9f84db3
</span></span><span style="display:flex;"><span>[root@bastion install]# openshift-install --dir=/opt/install wait-for install-complete --log-level debug
</span></span><span style="display:flex;"><span>DEBUG OpenShift Installer 4.6.4                    
</span></span><span style="display:flex;"><span>DEBUG Built from commit 6e02d049701437fa81521fe981405745a62c86c5 
</span></span><span style="display:flex;"><span>DEBUG Loading Install Config...                    
</span></span><span style="display:flex;"><span>DEBUG   Loading SSH Key...                         
</span></span><span style="display:flex;"><span>DEBUG   Loading Base Domain...                     
</span></span><span style="display:flex;"><span>DEBUG     Loading Platform...                      
</span></span><span style="display:flex;"><span>DEBUG   Loading Cluster Name...                    
</span></span><span style="display:flex;"><span>DEBUG     Loading Base Domain...                   
</span></span><span style="display:flex;"><span>DEBUG     Loading Platform...                      
</span></span><span style="display:flex;"><span>DEBUG   Loading Pull Secret...                     
</span></span><span style="display:flex;"><span>DEBUG   Loading Platform...                        
</span></span><span style="display:flex;"><span>DEBUG Using Install Config loaded from state file  
</span></span><span style="display:flex;"><span>INFO Waiting up to 40m0s for the cluster at https://api.ocp.suika.com:6443 to initialize... 
</span></span><span style="display:flex;"><span>DEBUG Cluster is initialized                       
</span></span><span style="display:flex;"><span>INFO Waiting up to 10m0s for the openshift-console route to be created... 
</span></span><span style="display:flex;"><span>DEBUG Route found in openshift-console namespace: console 
</span></span><span style="display:flex;"><span>DEBUG Route found in openshift-console namespace: downloads 
</span></span><span style="display:flex;"><span>DEBUG OpenShift console route is created           
</span></span><span style="display:flex;"><span>INFO Install complete!                            
</span></span><span style="display:flex;"><span>INFO To access the cluster as the system:admin user when using &#39;oc&#39;, run &#39;export KUBECONFIG=/opt/install/auth/kubeconfig&#39; 
</span></span><span style="display:flex;"><span>INFO Access the OpenShift web-console here: https://console-openshift-console.apps.ocp.suika.com 
</span></span><span style="display:flex;"><span>INFO Login to the console with user: &#34;kubeadmin&#34;, and password: &#34;XviuD-bnp8Y-RNYxL-zcp8R&#34; 
</span></span><span style="display:flex;"><span>INFO Time elapsed: 0s  
</span></span></code></pre></div><p>注意这个输出的kubeadmin用户及其密码，后面console登录会用到</p>
<h2 id="安装后的工作">安装后的工作：</h2>
<p>到上面那个输出openshift就已经安装完成了，做一点额外的工作</p>
<h3 id="检查状态">检查状态：</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@bastion ~]# oc get co
</span></span><span style="display:flex;"><span>NAME                                       VERSION   AVAILABLE   PROGRESSING   DEGRADED   SINCE
</span></span><span style="display:flex;"><span>authentication                             4.6.4     True        False         False      90s
</span></span><span style="display:flex;"><span>cloud-credential                           4.6.4     True        False         False      37m
</span></span><span style="display:flex;"><span>cluster-autoscaler                         4.6.4     True        False         False      21m
</span></span><span style="display:flex;"><span>config-operator                            4.6.4     True        False         False      22m
</span></span><span style="display:flex;"><span>console                                    4.6.4     True        False         False      8m50s
</span></span><span style="display:flex;"><span>csi-snapshot-controller                    4.6.4     True        False         False      22m
</span></span><span style="display:flex;"><span>dns                                        4.6.4     True        False         False      20m
</span></span><span style="display:flex;"><span>etcd                                       4.6.4     True        False         False      15m
</span></span><span style="display:flex;"><span>image-registry                             4.6.4     True        False         False      12m
</span></span><span style="display:flex;"><span>ingress                                    4.6.4     True        False         False      12m
</span></span><span style="display:flex;"><span>insights                                   4.6.4     True        False         False      22m
</span></span><span style="display:flex;"><span>kube-apiserver                             4.6.4     True        False         False      15m
</span></span><span style="display:flex;"><span>kube-controller-manager                    4.6.4     True        False         False      20m
</span></span><span style="display:flex;"><span>kube-scheduler                             4.6.4     True        False         False      16m
</span></span><span style="display:flex;"><span>kube-storage-version-migrator              4.6.4     True        False         False      20m
</span></span><span style="display:flex;"><span>machine-api                                4.6.4     True        False         False      21m
</span></span><span style="display:flex;"><span>machine-approver                           4.6.4     True        False         False      21m
</span></span><span style="display:flex;"><span>machine-config                             4.6.4     True        False         False      20m
</span></span><span style="display:flex;"><span>marketplace                                4.6.4     True        False         False      20m
</span></span><span style="display:flex;"><span>monitoring                                 4.6.4     True        False         False      10m
</span></span><span style="display:flex;"><span>network                                    4.6.4     True        False         False      23m
</span></span><span style="display:flex;"><span>node-tuning                                4.6.4     True        False         False      22m
</span></span><span style="display:flex;"><span>openshift-apiserver                        4.6.4     True        False         False      11m
</span></span><span style="display:flex;"><span>openshift-controller-manager               4.6.4     True        False         False      19m
</span></span><span style="display:flex;"><span>openshift-samples                          4.6.4     True        False         False      12m
</span></span><span style="display:flex;"><span>operator-lifecycle-manager                 4.6.4     True        False         False      21m
</span></span><span style="display:flex;"><span>operator-lifecycle-manager-catalog         4.6.4     True        False         False      21m
</span></span><span style="display:flex;"><span>operator-lifecycle-manager-packageserver   4.6.4     True        False         False      12m
</span></span><span style="display:flex;"><span>service-ca                                 4.6.4     True        False         False      22m
</span></span><span style="display:flex;"><span>storage                                    4.6.4     True        False         False      22m
</span></span></code></pre></div><h3 id="获取console地址">获取console地址：</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@bastion ~]# oc get route -A |grep openshift
</span></span><span style="display:flex;"><span>openshift-authentication   oauth-openshift     oauth-openshift.apps.ocp.suika.com                                 oauth-openshift     6443       passthrough/Redirect   None
</span></span><span style="display:flex;"><span>openshift-cnv              test-maven-app      test-maven-app-openshift-cnv.apps.ocp.suika.com                    test-maven-app      8080-tcp                          None
</span></span><span style="display:flex;"><span>openshift-console          console             console-openshift-console.apps.ocp.suika.com                       console             https      reencrypt/Redirect     None
</span></span><span style="display:flex;"><span>openshift-console          downloads           downloads-openshift-console.apps.ocp.suika.com                     downloads           http       edge/Redirect          None
</span></span><span style="display:flex;"><span>openshift-monitoring       alertmanager-main   alertmanager-main-openshift-monitoring.apps.ocp.suika.com          alertmanager-main   web        reencrypt/Redirect     None
</span></span><span style="display:flex;"><span>openshift-monitoring       grafana             grafana-openshift-monitoring.apps.ocp.suika.com                    grafana             https      reencrypt/Redirect     None
</span></span><span style="display:flex;"><span>openshift-monitoring       prometheus-k8s      prometheus-k8s-openshift-monitoring.apps.ocp.suika.com             prometheus-k8s      web        reencrypt/Redirect     None
</span></span><span style="display:flex;"><span>openshift-monitoring       thanos-querier      thanos-querier-openshift-monitoring.apps.ocp.suika.com             thanos-querier      web        reencrypt/Redirect     None
</span></span><span style="display:flex;"><span>openshift                  nodejs-sample       nodejs-sample-openshift.apps.ocp.suika.com                         nodejs-sample       8080-tcp                          None
</span></span></code></pre></div><p>添加上面的域名解析到任意一个master或haproxy的虚地址，然后就可以用web登录了，用前面的kubeadmin用户及密码</p>
<h3 id="配置时钟同步服务">配置时钟同步服务：</h3>
<p>通过浏览器登录到open shift的console之后，就会发现一个告警，集群没有配置NTP服务，然而又翻了一遍安装文档还是没地方讲这玩意怎么配。<br>
找了一下红帽的官网，发现解决的办法有两个，一个就是在主机启动后尽快登录，然后配置ntp服务，就是在重启后修改主机名的时候一并修改了NTP，然而这是什么鬼方案，如果不是环境不允许谁没事盯着ilo看启动到哪一步了……<br>
合理的是采用第二种方案：<br>
1、创建base64格式的chrony.conf</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>cat &lt;&lt; EOF | base64 -w 0
</span></span><span style="display:flex;"><span>server suikantp02-in.suika.com iburst
</span></span><span style="display:flex;"><span>driftfile /var/lib/chrony/drift
</span></span><span style="display:flex;"><span>makestep 1.0 3
</span></span><span style="display:flex;"><span>rtcsync
</span></span><span style="display:flex;"><span>logdir /var/log/chrony
</span></span><span style="display:flex;"><span>EOF
</span></span></code></pre></div><p>2、创建99_masters-chrony-configuration.yaml文件，并写入上面的信息：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>[root@bastion opt]# cat 99_masters-chrony-configuration.yaml <span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>machineconfiguration.openshift.io/v1<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>MachineConfig<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">machineconfiguration.openshift.io/role</span>:<span style="color:#bbb"> </span>master<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">name</span>:<span style="color:#bbb"> </span>masters-chrony-configuration<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">config</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">ignition</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">config</span>:<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">security</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">tls</span>:<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">timeouts</span>:<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">version</span>:<span style="color:#bbb"> </span><span style="color:#666">2.2.0</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">networkd</span>:<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">passwd</span>:<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">storage</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">files</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- <span style="color:#008000;font-weight:bold">contents</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#008000;font-weight:bold">source</span>:<span style="color:#bbb"> </span>data:text/plain;charset=utf-8;base64,c2VydmVyIGgzY250cDAyLWluLmgzYy5jb20gaWJ1cnN0CmRyaWZ0ZmlsZSAvdmFyL2xpYi9jaHJvbnkvZHJpZnQKbWFrZXN0ZXAgMS4wIDMKcnRjc3luYwpsb2dkaXIgL3Zhci9sb2cvY2hyb255Cg==<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#008000;font-weight:bold">verification</span>:<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">filesystem</span>:<span style="color:#bbb"> </span>root<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">mode</span>:<span style="color:#bbb"> </span><span style="color:#666">420</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">path</span>:<span style="color:#bbb"> </span>/etc/chrony.conf<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">osImageURL</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#34;&#34;</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>如果有worker节点创建一个类似的99_workers-chrony-configuration.yaml的文件。</p>
<p>3、应用文件：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>oc apply -f 99_masters-chrony-configuration.yaml
</span></span></code></pre></div><p>等一会，登录到任意主机，检查一下chrony的状态已是修改后的状态：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[core@ocpmaster03 ~]$ cat /etc/chrony.conf 
</span></span><span style="display:flex;"><span>server suikantp02-in.suika.com iburst
</span></span><span style="display:flex;"><span>driftfile /var/lib/chrony/drift
</span></span><span style="display:flex;"><span>makestep 1.0 3
</span></span><span style="display:flex;"><span>rtcsync
</span></span><span style="display:flex;"><span>logdir /var/log/chrony
</span></span><span style="display:flex;"><span>[core@ocpmaster03 ~]$ timedatectl 
</span></span><span style="display:flex;"><span>               Local time: Mon 2020-12-14 08:12:01 UTC
</span></span><span style="display:flex;"><span>           Universal time: Mon 2020-12-14 08:12:01 UTC
</span></span><span style="display:flex;"><span>                 RTC time: Mon 2020-12-14 08:12:01
</span></span><span style="display:flex;"><span>                Time zone: UTC (UTC, +0000)
</span></span><span style="display:flex;"><span>System clock synchronized: yes
</span></span><span style="display:flex;"><span>              NTP service: active
</span></span><span style="display:flex;"><span>          RTC in local TZ: no
</span></span></code></pre></div><p>至此，集群搭建完毕。</p>
<h2 id="参考文档">参考文档：</h2>
<p><a href="https://access.redhat.com/solutions/4906341">https://access.redhat.com/solutions/4906341</a><br>
<a href="https://misa.gitbook.io/k8s-ocp-yaml/openshift-docs/">https://misa.gitbook.io/k8s-ocp-yaml/openshift-docs/</a><br>
<a href="https://docs.openshift.com/container-platform/4.6/installing/installing_bare_metal/installing-bare-metal.html">https://docs.openshift.com/container-platform/4.6/installing/installing_bare_metal/installing-bare-metal.html</a></p>

    
        <div class="pb-14 taxonomy-list tags-list text-gray-600 text-sm font-medium">
            
                    <a class="bg-gray-100 py-2 px-3 rounded-lg" href="/tags/openshift/" alt="Openshift" >
                        Openshift
                    </a>
            
        </div>


    </section>
    
    
    
        <div class="giscus-comment">
    <script
      src="https://giscus.app/client.js"
      data-repo="suikaremilia/suikaremilia.github.io"
      data-repo-id="R_kgDOHZJINw"
      data-category="Announcements"
      data-category-id="DIC_kwDOHZJIN84CYPk_"
      data-mapping="pathname"
      data-strict="0"
      data-reactions-enabled="1"
      data-emit-metadata="0"
      data-input-position="top"
      data-theme="light"
      data-lang="zh-CN"
      
        data-loading="lazy"
      
      crossorigin="anonymous"
      async
    ></script>
</div>
    

    
    

    <footer>

    </footer>
</article>

        </div><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1 ">
    © 2023 — <a class="hover:text-gray-500" href="https://suikaremilia.github.io/">Long life, short world, trading of time, long strangle, hedging bets</a> <span class=" font-normal ">
</div>
    <div class="text-xs font-semibold text-gray-500 order-1 sm:order-2">
    <ul class="flex sm:justify-end gap-5">
    <li><a class="hover:text-gray-500" href="https://t.me/touhoumichong" target="_blank" rel="noopener noreferrer">Telegram</a></li><li><a class="hover:text-gray-500" href="mailto:suika@kadama.eu.org" target="_blank" rel="noopener noreferrer">Mail</a></li><li><a class="hover:text-gray-500" href="/index.xml" target="_blank" rel="noopener noreferrer">RSS</a></li>
    </ul>
</div>
</footer></body>
</html>
