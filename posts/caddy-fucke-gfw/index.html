<!DOCTYPE html>
<html lang="en-us" class="scroll-smooth">
    <head><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Caddy翻墙</title>
<meta name="description" content="Fuck GFW">
<link rel="canonical" href="https://suikaremilia.github.io/posts/caddy-fucke-gfw/">
<link rel="robots" href="/robots.txt" />
<link rel="stylesheet" href="https://suikaremilia.github.io/css/main.min.df1b948651de2b50af2bded0966d2d08b2a7217f36cbc0e2aaaaa9a7d2a94144.css" integrity="sha256-3xuUhlHeK1CvK97Qlm0tCLKnIX82y8Diqqqpp9KpQUQ=">
</head>
    <body class="max-w-screen-md px-10 mx-auto"><header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
    

<figure class="flex-none w-20 h-20 rounded-full overflow-hidden" ><a href="https://suikaremilia.github.io/"><img srcset="/img/firefox_hub66cb162f84e73856336c19b5d2d497e_36921_80x80_fill_q90_box_smart1.jpg 80w" src="/img/firefox.jpg" width="640" height="640" alt="Red Panda YOLO"></a></figure>

    <div class="flex flex-col gap-5">
    <a href="https://suikaremilia.github.io/">
    
    <h3 class="text-center sm:text-left text-4xl font-extrabold text-gray-800 ">Red Panda YOLO</h3>
    
</a>
    <nav>
    <ul class="flex flex-wrap justify-center uppercase text-xs font-semibold gap-7 text-gray-500 ">
        
        
        <li class="hover:text-gray-500"><a href="/">Home</a></li>
        
        <li class="hover:text-gray-500"><a href="/posts">Posts</a></li>
        
        <li class="hover:text-gray-500"><a href="/murmur">Ｍurmur</a></li>
        
        <li class="hover:text-gray-500"><a href="/tags">Tags</a></li>
        
    </ul>
</nav>
    </div>
</header><div id="content">
<article class="flex flex-col gap-10">
    <header class="flex flex-col gap-2">
        <h2 class="text-4xl leading-snug font-bold text-gray-900">Caddy翻墙</h2>

        <div class="text-sm font-semibold text-gray-500 flex gap-3">
        
<time datetime="2020-04-06 10:09:28 &#43;0000 UTC" title="2020-04-06 10:09:28 &#43;0000 UTC">
    6 April 2020
</time>
        
        —
        
            <a class="hover:text-gray-500" href="/categories/tech/" alt="Tech" >
                Tech
                </a>
        

        </div>
    </header>
    <section class="content text-lg text-gray-800">
    <p>Caddy有个模块很好用，经过简单的配置即可以https或http2的方式跨越防火墙，不需要单独申请证书同时还有正常网站做伪装，配合浏览器switch omega插件，方便快捷的访问被墙的资源。</p>
<h2 id="安装">安装：</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>curl https://getcaddy.com | bash -s personal http.forwardproxy
</span></span></code></pre></div><h2 id="配置一个正常网站">配置一个正常网站：</h2>
<p>创建文件并赋权等杂项：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>setcap <span style="color:#b44">&#39;cap_net_bind_service=+ep&#39;</span> /usr/local/bin/caddy
</span></span><span style="display:flex;"><span>useradd -r -d /var/www -M -s /sbin/nologin caddy
</span></span><span style="display:flex;"><span>chown -R caddy:caddy /var/www
</span></span><span style="display:flex;"><span>mkdir /etc/caddy
</span></span><span style="display:flex;"><span>chown -R root:caddy /etc/caddy
</span></span><span style="display:flex;"><span>touch /etc/caddy/Caddyfile
</span></span><span style="display:flex;"><span>chown caddy:caddy /etc/caddy/Caddyfile
</span></span><span style="display:flex;"><span>mkdir /var/log/caddy
</span></span><span style="display:flex;"><span>chown caddy:caddy /var/log/caddy/
</span></span><span style="display:flex;"><span>mkdir -p /var/www/xxx.yyy.zzz
</span></span><span style="display:flex;"><span>chown -R caddy:caddy /var/www
</span></span><span style="display:flex;"><span>mkdir -p /etc/ssl/caddy
</span></span><span style="display:flex;"><span>chown -R caddy:caddy /etc/ssl/caddy
</span></span></code></pre></div><p>编辑配置文件：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="">vim</span> <span style="">/etc/caddy/Caddyfile</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="">https:</span><span style="color:#080;font-style:italic">//xxx.yyy.zzz {           //xxx.yyy.zzz为可以解析到本机的域名，下同
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="">log</span> <span style="">/var/log/caddy/xxx.log</span>
</span></span><span style="display:flex;"><span>    <span style="">errors</span> <span style="">/var/log/caddy/xxx.error</span>
</span></span><span style="display:flex;"><span>    <span style="">root</span> <span style="">/var/www/xxx.yyy.zzz</span>
</span></span><span style="display:flex;"><span>    <span style="">gzip</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="">tls</span> <span style="">&lt;xxx@xxxxx.xxx&gt;</span> {        <span style="color:#080;font-style:italic">//随便一个邮箱
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>        <span style="">ciphers</span> <span style="">ECDHE-ECDSA-WITH-CHACHA20-POLY1305</span> <span style="">ECDHE-ECDSA-AES256-GCM-SHA384</span> <span style="">ECDHE-ECDSA-AES256-CBC-SHA</span>
</span></span><span style="display:flex;"><span>        <span style="">curves</span> <span style="">p384</span>
</span></span><span style="display:flex;"><span>        <span style="">key_type</span> <span style="">p384</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="">header</span> <span style="">/</span> {
</span></span><span style="display:flex;"><span>        <span style="">Strict-Transport-Security</span> <span style="color:#008000;font-weight:bold">&#34;max-age=31536000;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="">X-XSS-Protection</span> <span style="color:#b44">&#34;1; mode=block&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="">X-Content-Type-Options</span> <span style="color:#b44">&#34;nosniff&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="">X-Frame-Options</span> <span style="color:#b44">&#34;DENY&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span><span style="">}</span>
</span></span></code></pre></div><p>编辑一个简单的网页：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>vim /var/www/xxx.yyy.zzz/index.html
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080">&lt;!DOCTYPE html&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#008000;font-weight:bold">html</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#008000;font-weight:bold">head</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#008000;font-weight:bold">title</span>&gt;Hello from Caddy!&lt;/<span style="color:#008000;font-weight:bold">title</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#008000;font-weight:bold">head</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#008000;font-weight:bold">body</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#008000;font-weight:bold">h1</span> <span style="color:#b44">style</span><span style="color:#666">=</span><span style="color:#b44">&#34;font-family: sans-serif&#34;</span>&gt;This page is being served via Caddy!!!&lt;/<span style="color:#008000;font-weight:bold">h1</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#008000;font-weight:bold">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#008000;font-weight:bold">html</span>&gt;
</span></span></code></pre></div><p>测试是否可以正常建立网站：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>caddy -conf /etc/caddy/Caddyfile
</span></span></code></pre></div><p>按提示填写信息生成证书，如果没有报错，至此，应该可以打开一个网页，内容是加黑的This page is being served via Caddy!!!。</p>
<h2 id="配置代理">配置代理：</h2>
<p>在caddy的配置文件中加入forwardproxy信息，加入后内容如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="">https:</span><span style="color:#080;font-style:italic">//xxx.yyy.zzz {           //xxx.yyy.zzz为可以解析到本机的域名，下同
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="">log</span> <span style="">/var/log/caddy/xxx.log</span>
</span></span><span style="display:flex;"><span>    <span style="">errors</span> <span style="">/var/log/caddy/xxx.error</span>
</span></span><span style="display:flex;"><span>    <span style="">root</span> <span style="">/var/www/xxx.yyy.zzz</span>
</span></span><span style="display:flex;"><span>    <span style="">gzip</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="">tls</span> <span style="">&lt;xxx@xxxxx.xxx&gt;</span> {        <span style="color:#080;font-style:italic">//随便一个邮箱
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>        <span style="">ciphers</span> <span style="">ECDHE-ECDSA-WITH-CHACHA20-POLY1305</span> <span style="">ECDHE-ECDSA-AES256-GCM-SHA384</span> <span style="">ECDHE-ECDSA-AES256-CBC-SHA</span>
</span></span><span style="display:flex;"><span>        <span style="">curves</span> <span style="">p384</span>
</span></span><span style="display:flex;"><span>        <span style="">key_type</span> <span style="">p384</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="">forwardproxy</span> {
</span></span><span style="display:flex;"><span>	<span style="">basicauth</span> <span style="">xxx</span> <span style="">yyy</span>      <span style="color:#080;font-style:italic">//xxx yyy为用户及密码
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="">hide_ip</span>
</span></span><span style="display:flex;"><span>	<span style="">hide_via</span>
</span></span><span style="display:flex;"><span>	<span style="">probe_resistance</span> <span style="">caddyserver.com</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="">header</span> <span style="">/</span> {
</span></span><span style="display:flex;"><span>        <span style="">Strict-Transport-Security</span> <span style="color:#008000;font-weight:bold">&#34;max-age=31536000;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="">X-XSS-Protection</span> <span style="color:#b44">&#34;1; mode=block&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="">X-Content-Type-Options</span> <span style="color:#b44">&#34;nosniff&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="">X-Frame-Options</span> <span style="color:#b44">&#34;DENY&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span><span style="">}</span>
</span></span></code></pre></div><p>其中probe_resistance可以隐藏代理类型，是个实验功能，可加可不加</p>
<h2 id="证书">证书：</h2>
<p>caddy默认生成的证书在/root/.caddy下，ln它到/etc/ssl/caddy</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ln /root/.caddy/acme/acme-v02.api.letsencrypt.org/sites/xxx.yyy.zzz/xxx.yyy.zzz.key /etc/ssl/caddy/
</span></span><span style="display:flex;"><span>ln /root/.caddy/acme/acme-v02.api.letsencrypt.org/sites/xxx.yyy.zzz/xxx.yyy.zzz.crt /etc/ssl/caddy/
</span></span></code></pre></div><h2 id="日志权限">日志权限：</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>chown caddy:caddy /var/log/caddy/*
</span></span></code></pre></div><h2 id="管理服务">管理服务：</h2>
<p>配置systemd管理：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#b44">vim /etc/systemd/system/caddy.service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">[Unit]</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">Description</span><span style="color:#666">=</span><span style="color:#b44">Caddy HTTP/2 web server</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">Documentation</span><span style="color:#666">=</span><span style="color:#b44">https://caddyserver.com/docs</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">After</span><span style="color:#666">=</span><span style="color:#b44">network-online.target</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">Wants</span><span style="color:#666">=</span><span style="color:#b44">network-online.target systemd-networkd-wait-online.service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">[Service]</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">Restart</span><span style="color:#666">=</span><span style="color:#b44">on-abnormal</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">; User and group the process will run as.</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">User</span><span style="color:#666">=</span><span style="color:#b44">caddy</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">Group</span><span style="color:#666">=</span><span style="color:#b44">caddy</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">; Letsencrypt-issued certificates will be written to this directory.</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">Environment</span><span style="color:#666">=</span><span style="color:#b44">CADDYPATH=/etc/ssl/caddy</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">; Always set &#34;-root&#34; to something safe in case it gets forgotten in the Caddyfile.</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">ExecStart</span><span style="color:#666">=</span><span style="color:#b44">/usr/local/bin/caddy -log stdout -agree=true -conf=/etc/caddy/Caddyfile -root=/var/tmp</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">ExecReload</span><span style="color:#666">=</span><span style="color:#b44">/bin/kill -USR1 $MAINPID</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">; Use graceful shutdown with a reasonable timeout</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">KillMode</span><span style="color:#666">=</span><span style="color:#b44">mixed</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">KillSignal</span><span style="color:#666">=</span><span style="color:#b44">SIGQUIT</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">TimeoutStopSec</span><span style="color:#666">=</span><span style="color:#b44">5s</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">; Limit the number of file descriptors; see `man systemd.exec` for more limit settings.</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">LimitNOFILE</span><span style="color:#666">=</span><span style="color:#b44">1048576</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">; Unmodified caddy is not expected to use more than that.</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">LimitNPROC</span><span style="color:#666">=</span><span style="color:#b44">512</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">; Use private /tmp and /var/tmp, which are discarded after caddy stops.</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">PrivateTmp</span><span style="color:#666">=</span><span style="color:#b44">true</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">; Use a minimal /dev</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">PrivateDevices</span><span style="color:#666">=</span><span style="color:#b44">true</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">; Hide /home, /root, and /run/user. Nobody will steal your SSH-keys.</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">ProtectHome</span><span style="color:#666">=</span><span style="color:#b44">true</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">; Make /usr, /boot, /etc and possibly some more folders read-only.</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">ProtectSystem</span><span style="color:#666">=</span><span style="color:#b44">full</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">; … except /etc/ssl/caddy, because we want Letsencrypt-certificates there.</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">;   This merely retains r/w access rights, it does not add any new. Must still be writable on the host!</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">ReadWriteDirectories</span><span style="color:#666">=</span><span style="color:#b44">/etc/ssl/caddy</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">; The following additional security directives only work with systemd v229 or later.</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">; They further retrict privileges that can be gained by caddy. Uncomment if you like.</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">; Note that you may have to add capabilities required by any plugins in use.</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">CapabilityBoundingSet</span><span style="color:#666">=</span><span style="color:#b44">CAP_NET_BIND_SERVICE</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">AmbientCapabilities</span><span style="color:#666">=</span><span style="color:#b44">CAP_NET_BIND_SERVICE</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">NoNewPrivileges</span><span style="color:#666">=</span><span style="color:#b44">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">[Install]</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">WantedBy</span><span style="color:#666">=</span><span style="color:#b44">multi-user.target</span>
</span></span></code></pre></div><p>至此，可以通过systemd统一管理caddy服务：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl status caddy.service -l
</span></span></code></pre></div><h2 id="配置客户端">配置客户端：</h2>
<p>PC端firefox及chrome可以安装Switch Omega，然后添加一个https代理即可，注意添加用户名和密码否则每次都要输
IOS端可以shadowrocket，配置http2代理和https代理均可。</p>
<p>然后，然后就没有然后了……</p>

    
        <div class="pb-14 taxonomy-list tags-list text-gray-600 text-sm font-medium">
            
                    <a class="bg-gray-100 py-2 px-3 rounded-lg" href="/tags/proxy/" alt="Proxy" >
                        Proxy
                    </a>
            
        </div>


    </section>
    
    
    
        <div class="giscus-comment">
    <script
      src="https://giscus.app/client.js"
      data-repo="suikaremilia/suikaremilia.github.io"
      data-repo-id="R_kgDOHZJINw"
      data-category="Announcements"
      data-category-id="DIC_kwDOHZJIN84CYPk_"
      data-mapping="pathname"
      data-strict="0"
      data-reactions-enabled="1"
      data-emit-metadata="0"
      data-input-position="top"
      data-theme="light"
      data-lang="zh-CN"
      
        data-loading="lazy"
      
      crossorigin="anonymous"
      async
    ></script>
</div>
    

    
    

    <footer>

    </footer>
</article>

        </div><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1 ">
    © 2023 — <a class="hover:text-gray-500" href="https://suikaremilia.github.io/">Long life, short world, trading of time, long strangle, hedging bets</a> <span class=" font-normal ">
</div>
    <div class="text-xs font-semibold text-gray-500 order-1 sm:order-2">
    <ul class="flex sm:justify-end gap-5">
    <li><a class="hover:text-gray-500" href="https://t.me/touhoumichong" target="_blank" rel="noopener noreferrer">Telegram</a></li><li><a class="hover:text-gray-500" href="mailto:suika@kadama.eu.org" target="_blank" rel="noopener noreferrer">Mail</a></li><li><a class="hover:text-gray-500" href="/index.xml" target="_blank" rel="noopener noreferrer">RSS</a></li>
    </ul>
</div>
</footer></body>
</html>
