<!DOCTYPE html>
<html lang="en-us" class="scroll-smooth">
    <head><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CEPH Nautilus Zabbix module Setup</title>
<meta name="description" content="CEPH可以通过mgr节点的zabbix模块实现监控">
<link rel="canonical" href="https://suikaremilia.github.io/posts/ceph-nautilus-zabbix-module-setup/">
<link rel="robots" href="/robots.txt" />
<link rel="stylesheet" href="https://suikaremilia.github.io/css/main.min.df1b948651de2b50af2bded0966d2d08b2a7217f36cbc0e2aaaaa9a7d2a94144.css" integrity="sha256-3xuUhlHeK1CvK97Qlm0tCLKnIX82y8Diqqqpp9KpQUQ=">
</head>
    <body class="max-w-screen-md px-10 mx-auto"><header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
    

<figure class="flex-none w-20 h-20 rounded-full overflow-hidden" ><a href="https://suikaremilia.github.io/"><img srcset="/img/firefox_hub66cb162f84e73856336c19b5d2d497e_36921_80x80_fill_q90_box_smart1.jpg 80w" src="/img/firefox.jpg" width="640" height="640" alt="Red Panda YOLO"></a></figure>

    <div class="flex flex-col gap-5">
    <a href="https://suikaremilia.github.io/">
    
    <h3 class="text-center sm:text-left text-4xl font-extrabold text-gray-800 ">Red Panda YOLO</h3>
    
</a>
    <nav>
    <ul class="flex flex-wrap justify-center uppercase text-xs font-semibold gap-7 text-gray-500 ">
        
        
        <li class="hover:text-gray-500"><a href="/">Home</a></li>
        
        <li class="hover:text-gray-500"><a href="/posts">Posts</a></li>
        
        <li class="hover:text-gray-500"><a href="/murmur">Ｍurmur</a></li>
        
        <li class="hover:text-gray-500"><a href="/tags">Tags</a></li>
        
    </ul>
</nav>
    </div>
</header><div id="content">
<article class="flex flex-col gap-10">
    <header class="flex flex-col gap-2">
        <h2 class="text-4xl leading-snug font-bold text-gray-900">CEPH Nautilus Zabbix module Setup</h2>

        <div class="text-sm font-semibold text-gray-500 flex gap-3">
        
<time datetime="2020-03-02 15:13:58 &#43;0000 UTC" title="2020-03-02 15:13:58 &#43;0000 UTC">
    2 March 2020
</time>
        
        —
        
            <a class="hover:text-gray-500" href="/categories/tech/" alt="Tech" >
                Tech
                </a>
        

        </div>
    </header>
    <section class="content text-lg text-gray-800">
    <p>CEPH可以通过mgr节点的zabbix模块实现监控</p>
<p>不同于普通的agent模式，CEPH自带的zabbix模块通过trapper模式工作，mgr节点收集集群信息并向Zabbix Server发送。</p>
<h2 id="1环境说明">1、环境说明：</h2>
<p>3节点CEPH集群，每个node都是mgr节点;<br>
部署Nautilus 14.2.7；<br>
Zabbix Server版本：4.2.1</p>
<h2 id="2安装部署">2、安装部署：</h2>
<p>在所有mgr节点上安装zabbix-sender<br>
<strong>配置yum：</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># rpm -Uvh https://repo.zabbix.com/zabbix/4.4/rhel/7/x86_64/zabbix-release-4.4-1.el7.noarch.rpm
</span></span></code></pre></div><p><strong>安装sender：</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># yum install zabbix-sender -y
</span></span></code></pre></div><h2 id="3配置zabbix模块">3、配置zabbix模块：</h2>
<p>在任意一个mgr节点上执行如下配置：<br>
启用zabbix module：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-v" data-lang="v"><span style="display:flex;"><span><span style="color:#666">#</span> <span style="color:#b8860b">ceph</span> <span style="color:#b8860b">mgr</span> <span style="color:#a2f;font-weight:bold">module</span> <span style="color:#b8860b">enable</span> <span style="color:#b8860b">zabbix</span>
</span></span></code></pre></div><p>指定zabbix server，如果有多个可以用&quot;,&ldquo;隔开，并且可以添加&rdquo;:&ldquo;来指定服务器端口，此处只有最简单的配置：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># ceph zabbix config-set zabbix_host zabbix.test.com
</span></span></code></pre></div><p>指定zabbix_sender的位置：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># which zabbix_sender 
</span></span><span style="display:flex;"><span>/usr/bin/zabbix_sender
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># ceph zabbix config-set zabbix_sender /usr/bin/zabbix_sender
</span></span><span style="display:flex;"><span>Configuration option zabbix_sender updated
</span></span></code></pre></div><p>指定identifier，这里很奇怪，只能是某个mgr节点的主机名，其他的可以设置成功但是发送失败，不知道我哪里配的有问题：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># ceph zabbix config-set identifier &#34;ceph01.test.com&#34;
</span></span></code></pre></div><p>后面如果有需要可以定义server的端口等，命令跟前面的相仿，这里就不配了。<br>
查看一下当前的配置：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># ceph zabbix config-show
</span></span></code></pre></div><p>查看一下自带的监控模板，后面会用到：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># find / -iname zabbix_template.xml
</span></span><span style="display:flex;"><span>/usr/share/ceph/mgr/zabbix/zabbix_template.xml
</span></span></code></pre></div><h2 id="4配置zabbix-server">4、配置zabbix server：</h2>
<p>登录Zabbix Web UI导入前面找到的监控模板，模板也可以在<a href="http://www.voidcn.com/link?url=https://github.com/ceph/ceph/tree/master/src/pybind/mgr/zabbix">github</a>中找，默认选项导入即可：</p>
<p><img src="1583826557541.png" alt=""></p>
<p><img src="1583826581767.png" alt=""></p>
<p>创建主机组：<br>
<img src="1583826608847.png" alt=""></p>
<p>添加主机并关联主机组和模板，如果有需要主机可以关联多个模板，比如系统的监控：</p>
<p><img src="1583826718228.png" alt=""></p>
<p><img src="1583826726630.png" alt=""></p>
<p><img src="1583826768418.png" alt=""></p>
<p>配置用户告警：
<img src="1583915228007.png" alt=""><br>
<img src="1583915254342.png" alt=""></p>
<p>至此配置完成。</p>
<h2 id="5测试配置">5、测试配置</h2>
<p>任意一台mgr节点测试：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># ceph zabbix send 
</span></span><span style="display:flex;"><span>Sending data to Zabbix
</span></span></code></pre></div><p>如果发送不成功会导致ceph健康状态告警，检查端口通信情况及zabbix server的trapper模式是否被禁用，以及上面的步骤是不是哪里配置错了。</p>
<blockquote>
<p><a href="https://docs.ceph.com/docs/master/mgr/zabbix">https://docs.ceph.com/docs/master/mgr/zabbix/</a><br>
<a href="https://www.cnblogs.com/lbjstill/p/12169820.html">https://www.cnblogs.com/lbjstill/p/12169820.html</a></p>
</blockquote>

    
        <div class="pb-14 taxonomy-list tags-list text-gray-600 text-sm font-medium">
            
                    <a class="bg-gray-100 py-2 px-3 rounded-lg" href="/tags/ceph/" alt="CEPH" >
                        CEPH
                    </a>
            
                    <a class="bg-gray-100 py-2 px-3 rounded-lg" href="/tags/monitor/" alt="Monitor" >
                        Monitor
                    </a>
            
        </div>


    </section>
    
    
    
        <div class="giscus-comment">
    <script
      src="https://giscus.app/client.js"
      data-repo="suikaremilia/suikaremilia.github.io"
      data-repo-id="R_kgDOHZJINw"
      data-category="Announcements"
      data-category-id="DIC_kwDOHZJIN84CYPk_"
      data-mapping="pathname"
      data-strict="0"
      data-reactions-enabled="1"
      data-emit-metadata="0"
      data-input-position="top"
      data-theme="light"
      data-lang="zh-CN"
      
        data-loading="lazy"
      
      crossorigin="anonymous"
      async
    ></script>
</div>
    

    
    

    <footer>

    </footer>
</article>

        </div><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1 ">
    © 2023 — <a class="hover:text-gray-500" href="https://suikaremilia.github.io/">Long life, short world, trading of time, long strangle, hedging bets</a> <span class=" font-normal ">
</div>
    <div class="text-xs font-semibold text-gray-500 order-1 sm:order-2">
    <ul class="flex sm:justify-end gap-5">
    <li><a class="hover:text-gray-500" href="https://t.me/touhoumichong" target="_blank" rel="noopener noreferrer">Telegram</a></li><li><a class="hover:text-gray-500" href="mailto:suika@kadama.eu.org" target="_blank" rel="noopener noreferrer">Mail</a></li><li><a class="hover:text-gray-500" href="/index.xml" target="_blank" rel="noopener noreferrer">RSS</a></li>
    </ul>
</div>
</footer></body>
</html>
