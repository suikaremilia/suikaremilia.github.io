<!DOCTYPE html>
<html lang="en-us" class="scroll-smooth">
    <head><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CEPH规划</title>
<meta name="description" content="CEPH so hard">
<link rel="canonical" href="https://suikaremilia.github.io/posts/ceph-architecture/">
<link rel="robots" href="/robots.txt" />
<link rel="stylesheet" href="https://suikaremilia.github.io/css/main.min.df1b948651de2b50af2bded0966d2d08b2a7217f36cbc0e2aaaaa9a7d2a94144.css" integrity="sha256-3xuUhlHeK1CvK97Qlm0tCLKnIX82y8Diqqqpp9KpQUQ=">
</head>
    <body class="max-w-screen-md px-10 mx-auto"><header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
    

<figure class="flex-none w-20 h-20 rounded-full overflow-hidden" ><a href="https://suikaremilia.github.io/"><img srcset="/img/firefox_hub66cb162f84e73856336c19b5d2d497e_36921_80x80_fill_q90_box_smart1.jpg 80w" src="/img/firefox.jpg" width="640" height="640" alt="Red Panda YOLO"></a></figure>

    <div class="flex flex-col gap-5">
    <a href="https://suikaremilia.github.io/">
    
    <h3 class="text-center sm:text-left text-4xl font-extrabold text-gray-800 ">Red Panda YOLO</h3>
    
</a>
    <nav>
    <ul class="flex flex-wrap justify-center uppercase text-xs font-semibold gap-7 text-gray-500 ">
        
        
        <li class="hover:text-gray-500"><a href="/">Home</a></li>
        
        <li class="hover:text-gray-500"><a href="/posts">Posts</a></li>
        
        <li class="hover:text-gray-500"><a href="/murmur">Ｍurmur</a></li>
        
        <li class="hover:text-gray-500"><a href="/tags">Tags</a></li>
        
    </ul>
</nav>
    </div>
</header><div id="content">
<article class="flex flex-col gap-10">
    <header class="flex flex-col gap-2">
        <h2 class="text-4xl leading-snug font-bold text-gray-900">CEPH规划</h2>

        <div class="text-sm font-semibold text-gray-500 flex gap-3">
        
<time datetime="2020-05-20 15:16:05 &#43;0000 UTC" title="2020-05-20 15:16:05 &#43;0000 UTC">
    20 May 2020
</time>
        
        —
        
            <a class="hover:text-gray-500" href="/categories/tech/" alt="Tech" >
                Tech
                </a>
        

        </div>
    </header>
    <section class="content text-lg text-gray-800">
    <h2 id="背景">背景</h2>
<p>终于准备用Nautilus做生产环境了！<br>
目前，Ceph 主要有三种企业级应用场景：</p>
<ul>
<li>IOPS 密集型：这种类型的场景通常是支撑在虚拟化/私有云上运行数据库。如在 OpenStack 上运行 Mysql、MariaDB 或 PostgreSQL 等。IOPS 密集型场景对磁盘的性能要求较高，最好使用全闪架构。如果使用混合架构，机械盘转速需要 1.2 万，并使用高速盘存储频繁写操作的日志或元数据。</li>
<li>高吞吐量型：这种类型的应用场景主要是大块数据传输，如图像、视频、音频文件等。高吞吐量型磁盘的要求没有 IOPS 密集型高，但需要配置较高的网络。同时也需要配置 SSD 来处理写日志。</li>
<li>高容量型：这种场景主要用于存储归档、离线数据。它对磁盘的容量要求高，对性能无过多要求。写日志也可以存储在 HDD 上。<br>
此次计划部署一套带宽型的用来提供S3服务，所以部署第二种就好。</li>
</ul>
<h2 id="硬件规划">硬件规划：</h2>
<p>nautilus采用blustore比filestore的性能大大提升，毕竟传输路径短了很多：<br>
<img src="1594881842550.png" alt="File Store VS Blue Store"></p>
<p>随之而来的问题是BlueStore 存储引擎的实现，需要存储数据和元数据。目前 Ceph BuleStore 的元数据存储在 RocksDB（K-V 数据库）中。通过为 RocksEnv 提供操作接口，RocksDB 存放在 BlueFS 上。由于 BlueFS 最终通过 RocksDB，承载的是 BlueStore 存储引擎中的元数据，因此它的性能会很大程度上影响整个 Ceph 的性能。所以，要为它提供高速硬盘。<br>
Redhat建议，在新的bluestore架构下，如果用NVMe做metedata/jouranl，对应HDD的OSD是1：12；如果普通SSD做metedata/jouranl，则与HDD的比例为1：4 <a href="https://access.redhat.com/documentation/en-us/red_hat_ceph_storage/4/html/hardware_guide/server-and-rack-solutions_hw"><!-- raw HTML omitted -->1<!-- raw HTML omitted --></a>
在此基础上，其他按照官方建议配置。</p>
<table>
<thead>
<tr>
<th style="text-align:left">Device</th>
<th style="text-align:left">Size</th>
<th style="text-align:left">Count</th>
<th style="text-align:left">Use</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">CPU</td>
<td style="text-align:left">Inter Xeon 6252</td>
<td style="text-align:left">2</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">Memor</td>
<td style="text-align:left">32GB</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">DISK</td>
<td style="text-align:left">4TB</td>
<td style="text-align:left">12</td>
<td style="text-align:left">OSD</td>
</tr>
<tr>
<td style="text-align:left">SSD</td>
<td style="text-align:left">480GB</td>
<td style="text-align:left">2</td>
<td style="text-align:left">Operation</td>
</tr>
<tr>
<td style="text-align:left">NVMe</td>
<td style="text-align:left">4TB</td>
<td style="text-align:left">2</td>
<td style="text-align:left">blockk.db</td>
</tr>
<tr>
<td style="text-align:left">Network</td>
<td style="text-align:left">10GB</td>
<td style="text-align:left">2</td>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<p>以上配置保证了：<br>
1、每HDD的OSD至少对应5GB内存；<br>
2、每2 GHZ CPU每0.5 Cores每HDD；<br>
3、前端网络和后端网络的带宽，提供每12OSD有10GB带宽；<br>
4、SSD组成raid1保证操作系统安全；<br>
5、NVMe通过PCIE组成raid1，简化db磁盘损坏后的更换（此处不符合官方最佳实践）</p>
<p>共6台这样硬件配置的服务器，每台的作用如下：</p>
<table>
<thead>
<tr>
<th>hostname</th>
<th>IP addr</th>
<th>Roles</th>
</tr>
</thead>
<tbody>
<tr>
<td>rhcs01-st</td>
<td>10.64.0.80 <!-- raw HTML omitted -->10.64.4.80</td>
<td>OSD <!-- raw HTML omitted -->MON<!-- raw HTML omitted -->MGR</td>
</tr>
<tr>
<td>rhcs02-st</td>
<td>10.64.0.81 <!-- raw HTML omitted -->10.64.4.81</td>
<td>OSD <!-- raw HTML omitted -->RGW<!-- raw HTML omitted -->MDS</td>
</tr>
<tr>
<td>rhcs03-st</td>
<td>10.64.0.82 <!-- raw HTML omitted -->10.64.4.82</td>
<td>OSD <!-- raw HTML omitted -->MON<!-- raw HTML omitted -->MGR</td>
</tr>
<tr>
<td>rhcs04-st</td>
<td>10.64.0.83 <!-- raw HTML omitted -->10.64.4.83</td>
<td>OSD <!-- raw HTML omitted -->RGW<!-- raw HTML omitted -->MDS</td>
</tr>
<tr>
<td>rhcs05-st</td>
<td>10.64.0.84 <!-- raw HTML omitted -->10.64.4.84</td>
<td>OSD <!-- raw HTML omitted -->MON<!-- raw HTML omitted -->MGR</td>
</tr>
<tr>
<td>rhcs06-st</td>
<td>10.64.0.85 <!-- raw HTML omitted -->10.64.4.86</td>
<td>OSD <!-- raw HTML omitted -->RGW<!-- raw HTML omitted -->MDS</td>
</tr>
</tbody>
</table>
<h2 id="软件计划">软件计划：</h2>
<p>确定使用RHCS4.1来部署，其与开源版本对应关系如下：</p>
<table>
<thead>
<tr>
<th>Upstream Code Name</th>
<th>Downstream Release Name</th>
<th>Red Hat Ceph Storage Package Version (RHEL 8.x)</th>
<th>Red Hat Ceph Storage Package Version (RHEL 7.x)</th>
<th>Red Hat Ceph Ansible Package Version 	Release Month</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Nautilus 	Red Hat Ceph Storage 4.1</td>
<td>14.2.8-59.el8cp</td>
<td>14.2.8-50.el7cp</td>
<td>ceph-ansible-4.0.23-1</td>
<td>June, 2020</td>
<td></td>
</tr>
<tr>
<td>Nautilus</td>
<td>Red Hat Ceph Storage 4.0</td>
<td>14.2.4-125.el8cp</td>
<td>14.2.4-51.el7cp</td>
<td>ceph-ansible-4.0.14-1</td>
<td>January, 2020</td>
</tr>
</tbody>
</table>
<p>而RHCS4支持的操作系统如下：</p>
<table>
<thead>
<tr>
<th>Vendor</th>
<th>Version</th>
</tr>
</thead>
<tbody>
<tr>
<td>Redhat Enterprise Linux</td>
<td>8.2<!-- raw HTML omitted -->8.1</td>
</tr>
<tr>
<td>Redhat Enterprise Linux</td>
<td>7.8<!-- raw HTML omitted -->7.7</td>
</tr>
</tbody>
</table>
<p>因此，系统选用RHEL8.2</p>
<h2 id="小结">小结</h2>
<p>选定了软件版本后，按标准来配置即可。由于是分布式存储，主要还是考虑硬盘和网络，而硬盘的配置跟存储整个架构有很大关系。</p>
<h2 id="参考文档">参考文档：</h2>
<p><a href="https://access.redhat.com/documentation/en-us/red_hat_ceph_storage/4/html/hardware_guide/index">https://access.redhat.com/documentation/en-us/red_hat_ceph_storage/4/html/hardware_guide/index</a></p>

    
        <div class="pb-14 taxonomy-list tags-list text-gray-600 text-sm font-medium">
            
                    <a class="bg-gray-100 py-2 px-3 rounded-lg" href="/tags/ceph/" alt="CEPH" >
                        CEPH
                    </a>
            
        </div>


    </section>
    
    
    
        <div class="giscus-comment">
    <script
      src="https://giscus.app/client.js"
      data-repo="suikaremilia/suikaremilia.github.io"
      data-repo-id="R_kgDOHZJINw"
      data-category="Announcements"
      data-category-id="DIC_kwDOHZJIN84CYPk_"
      data-mapping="pathname"
      data-strict="0"
      data-reactions-enabled="1"
      data-emit-metadata="0"
      data-input-position="top"
      data-theme="light"
      data-lang="zh-CN"
      
        data-loading="lazy"
      
      crossorigin="anonymous"
      async
    ></script>
</div>
    

    
    

    <footer>

    </footer>
</article>

        </div><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1 ">
    © 2023 — <a class="hover:text-gray-500" href="https://suikaremilia.github.io/">Long life, short world, trading of time, long strangle, hedging bets</a> <span class=" font-normal ">
</div>
    <div class="text-xs font-semibold text-gray-500 order-1 sm:order-2">
    <ul class="flex sm:justify-end gap-5">
    <li><a class="hover:text-gray-500" href="https://t.me/touhoumichong" target="_blank" rel="noopener noreferrer">Telegram</a></li><li><a class="hover:text-gray-500" href="mailto:suika@kadama.eu.org" target="_blank" rel="noopener noreferrer">Mail</a></li><li><a class="hover:text-gray-500" href="/index.xml" target="_blank" rel="noopener noreferrer">RSS</a></li>
    </ul>
</div>
</footer></body>
</html>
