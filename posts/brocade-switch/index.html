<!DOCTYPE html>
<html lang="en-us" class="scroll-smooth">
    <head><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>记一次博科光交排障</title>
<meta name="description" content="最近一台3PAR一直报CRC错误，3PAR的排障还算简单，就几条命令分析一下输出。">
<link rel="canonical" href="https://suikaremilia.github.io/posts/brocade-switch/">
<link rel="robots" href="/robots.txt" />
<link rel="stylesheet" href="https://suikaremilia.github.io/css/main.min.df1b948651de2b50af2bded0966d2d08b2a7217f36cbc0e2aaaaa9a7d2a94144.css" integrity="sha256-3xuUhlHeK1CvK97Qlm0tCLKnIX82y8Diqqqpp9KpQUQ=">
</head>
    <body class="max-w-screen-md px-10 mx-auto"><header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
    

<figure class="flex-none w-20 h-20 rounded-full overflow-hidden" ><a href="https://suikaremilia.github.io/"><img srcset="/img/firefox_hub66cb162f84e73856336c19b5d2d497e_36921_80x80_fill_q90_box_smart1.jpg 80w" src="/img/firefox.jpg" width="640" height="640" alt="Red Panda YOLO"></a></figure>

    <div class="flex flex-col gap-5">
    <a href="https://suikaremilia.github.io/">
    
    <h3 class="text-center sm:text-left text-4xl font-extrabold text-gray-800 ">Red Panda YOLO</h3>
    
</a>
    <nav>
    <ul class="flex flex-wrap justify-center uppercase text-xs font-semibold gap-7 text-gray-500 ">
        
        
        <li class="hover:text-gray-500"><a href="/">Home</a></li>
        
        <li class="hover:text-gray-500"><a href="/posts">Posts</a></li>
        
        <li class="hover:text-gray-500"><a href="/murmur">Ｍurmur</a></li>
        
        <li class="hover:text-gray-500"><a href="/tags">Tags</a></li>
        
    </ul>
</nav>
    </div>
</header><div id="content">
<article class="flex flex-col gap-10">
    <header class="flex flex-col gap-2">
        <h2 class="text-4xl leading-snug font-bold text-gray-900">记一次博科光交排障</h2>

        <div class="text-sm font-semibold text-gray-500 flex gap-3">
        
<time datetime="2020-08-03 19:24:01 &#43;0000 UTC" title="2020-08-03 19:24:01 &#43;0000 UTC">
    3 August 2020
</time>
        
        —
        
            <a class="hover:text-gray-500" href="/categories/tech/" alt="Tech" >
                Tech
                </a>
        

        </div>
    </header>
    <section class="content text-lg text-gray-800">
    <p>最近一台3PAR一直报CRC错误，3PAR的排障还算简单，就几条命令分析一下输出。<br>
然而，这次故障比较诡异：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#b44">% showport</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">N:S:P      Mode   State ----Node_WWN---- -Port_WWN/HW_Addr- Type Protocol Label Partner FailoverState</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">0:0:1    target   ready 2FF70002AC01AE3E   20010002AC01AE3E host       FC     -   1:0:1          none</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">0:0:2    target   ready 2FF70002AC01AE3E   20020002AC01AE3E host       FC     -   1:0:2          none</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">0:1:1 initiator   ready 50002ACFF701AE3E   50002AC01101AE3E disk      SAS  DP-1       -             -</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">0:1:2 initiator   ready 50002ACFF701AE3E   50002AC01201AE3E disk      SAS  DP-2       -             -</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">0:3:1      peer offline                -       3464A9EAFD3D free       IP   IP0       -             -</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">1:0:1    target   ready 2FF70002AC01AE3E   21010002AC01AE3E host       FC     -   0:0:1          none</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">1:0:2    target   ready 2FF70002AC01AE3E   21020002AC01AE3E host       FC     -   0:0:2          none</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">1:1:1 initiator   ready 50002ACFF701AE3E   50002AC11101AE3E disk      SAS  DP-1       -             -</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">1:1:2 initiator   ready 50002ACFF701AE3E   50002AC11201AE3E disk      SAS  DP-2       -             -</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">1:3:1      peer offline                -       94188246CFDD free       IP   IP1       -             -</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">-----------------------------------------------------------------------------------------------------</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#b44">% showportlesb hist 1:0:1</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">ID    ALPA ----Port_WWN---- LinkFail LossSync LossSig PrimSeq InvWord InvCRC</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">&lt;1:0:1&gt; 0x15e00 21010002AC01AE3E        2        3       0       0     163  19870</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">host42  0x15300 51402EC000F79136        2        0       0       0       0      0</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">host43  0x15400 51402EC000F77CFA        2        0       0       0       0      0</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">host44  0x15500 51402EC000F79236        2        0       0       0       0      0</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">host45  0x15600 51402EC000F77D06        2        0       0       0       0      0</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">host48  0x15900 51402EC000F77F0E        2        0       0       0       0      0</span>
</span></span></code></pre></div><p>一般情况3PAR端<code>showportlesb</code>会显示哪个host报crc错误，这次直接报接在同一交换机上的两个控制器端口&lt;1:0:1&gt;和&lt;0:0:1&gt;故障，这让人不得不怀疑控制器其实是没有故障的，故障在交换机侧，毕竟不同控制器的端口同时报错概率不大。</p>
<p>于是，清除3par侧的计数</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>showportlesb reset
</span></span></code></pre></div><p>继续排查交换机侧：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#b44">&gt; porterrshow </span>
</span></span><span style="display:flex;"><span>          <span style="color:#b44">frames      enc    crc    crc    too    too    bad    enc   disc   link   loss   loss   frjt   fbsy    c3timeout    pcs</span>
</span></span><span style="display:flex;"><span>       <span style="color:#b44">tx     rx      in    err    g_eof  shrt   long   eof     out   c3    fail    sync   sig                   tx    rx     err</span>
</span></span><span style="display:flex;"><span>  <span style="color:#b44">0:  463.2m 201.1m   0      0      0      0      0      0      0      0      0      0      0      0      0      0      0      0   </span>
</span></span><span style="display:flex;"><span>  <span style="color:#b44">1:  462.4m 200.9m   0      0      0      0      0      0      0      0      0      0      0      0      0      0      0      0</span>
</span></span><span style="display:flex;"><span> <span style="color:#b44">85:   32.6m  56.0m 424    423    423      0      0      0      0      0      0      0      0      0      0      0      0      0   </span>
</span></span><span style="display:flex;"><span> <span style="color:#b44">86:    4.6m   4.9m   0      0      0      0      0      0      0      0      0      0      0      0      0      0      0      0</span>
</span></span></code></pre></div><p>果然一个主机的端口报错，考虑端口光衰</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&gt; sfpshow <span style="color:#666">85</span>
</span></span><span style="display:flex;"><span>Identifier:  <span style="color:#666">3</span>    SFP
</span></span><span style="display:flex;"><span>Connector:   <span style="color:#666">7</span>    LC
</span></span><span style="display:flex;"><span>Transceiver: 540c404000000000 2,4,8_Gbps M5,M6 sw Short_dist
</span></span><span style="display:flex;"><span>Encoding:    <span style="color:#666">1</span>    8B10B
</span></span><span style="display:flex;"><span>Baud Rate:   <span style="color:#666">85</span>   <span style="color:#666">(</span>units <span style="color:#666">100</span> megabaud<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>Length 9u:   <span style="color:#666">0</span>    <span style="color:#666">(</span>units km<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>Length 9u:   <span style="color:#666">0</span>    <span style="color:#666">(</span>units <span style="color:#666">100</span> meters<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>Length 50u <span style="color:#666">(</span>OM2<span style="color:#666">)</span>:  <span style="color:#666">5</span>    <span style="color:#666">(</span>units <span style="color:#666">10</span> meters<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>Length 50u <span style="color:#666">(</span>OM3<span style="color:#666">)</span>:  <span style="color:#666">0</span>    <span style="color:#666">(</span>units <span style="color:#666">10</span> meters<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>Length 62.5u:2    <span style="color:#666">(</span>units <span style="color:#666">10</span> meters<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>Length Cu:   <span style="color:#666">0</span>    <span style="color:#666">(</span>units <span style="color:#666">1</span> meter<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>Vendor Name: BROCADE         
</span></span><span style="display:flex;"><span>Vendor OUI:  00:05:1e
</span></span><span style="display:flex;"><span>Vendor PN:   57-1000012-01   
</span></span><span style="display:flex;"><span>Vendor Rev:  A   
</span></span><span style="display:flex;"><span>Wavelength:  <span style="color:#666">850</span>  <span style="color:#666">(</span>units nm<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>Options:     003a Loss_of_Sig,Tx_Fault,Tx_Disable
</span></span><span style="display:flex;"><span>BR Max:      <span style="color:#666">0</span>   
</span></span><span style="display:flex;"><span>BR Min:      <span style="color:#666">0</span>   
</span></span><span style="display:flex;"><span>Serial No:   UAF109390000C3N 
</span></span><span style="display:flex;"><span>Date Code:   <span style="color:#666">090924</span>  
</span></span><span style="display:flex;"><span>DD Type:     0x68
</span></span><span style="display:flex;"><span>Enh Options: 0xfa
</span></span><span style="display:flex;"><span>Status/Ctrl: 0x82
</span></span><span style="display:flex;"><span>Alarm flags<span style="color:#666">[</span>0,1<span style="color:#666">]</span> <span style="color:#666">=</span> 0x5, 0x40
</span></span><span style="display:flex;"><span>Warn Flags<span style="color:#666">[</span>0,1<span style="color:#666">]</span> <span style="color:#666">=</span> 0x5, 0x40
</span></span><span style="display:flex;"><span>                                           Alarm                  Warn
</span></span><span style="display:flex;"><span>                                    low         high       low         high
</span></span><span style="display:flex;"><span>Temperature: <span style="color:#666">42</span>      Centigrade      -10        <span style="color:#666">90</span>         -5          <span style="color:#666">85</span>
</span></span><span style="display:flex;"><span>Current:     7.140   mAmps           1.000      17.000     2.000       14.000 
</span></span><span style="display:flex;"><span>Voltage:     3292.4  mVolts          2900.0     3700.0     3000.0      3600.0 
</span></span><span style="display:flex;"><span>RX Power:    -2.3    dBm <span style="color:#666">(</span>582.9uW<span style="color:#666">)</span>   10.0   uW  1258.9 uW  15.8   uW   1000.0 uW
</span></span><span style="display:flex;"><span>TX Power:    -3.3    dBm <span style="color:#666">(</span>263.1 uW<span style="color:#666">)</span>  125.9  uW  631.0  uW  158.5  uW   562.3  uW
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>State transitions: <span style="color:#666">1</span>
</span></span><span style="display:flex;"><span>Last poll time: 08-03-2020 UTC Thu 08:12:57
</span></span></code></pre></div><p><code>TX Power</code>才200多，过低，换之，遂好……</p>
<h2 id="附博科交换机常用的内容如下">附：博科交换机常用的内容如下：</h2>
<p><strong>默认IP:</strong><br>
10.77.77.77<br>
<strong>默认密码：</strong>
admin/password<br>
root/fibrane<br>
<strong>查看、设置网络：</strong><br>
ipaddrshow<br>
ipaddrset<br>
<strong>显示、添加license：</strong><br>
licenseshow<br>
licenseadd<br>
<strong>查看信息：</strong><br>
switchshow<br>
alishow<br>
zoneshow<br>
cfgshow<br>
fabrishow<br>
<strong>配置时钟：</strong><br>
tsclockserver &ldquo;ntp server&rdquo;<br>
tstimezone &ndash;interactive<br>
<strong>清除状态：</strong><br>
statsclear</p>
<p>排障的话就需要用到<code>porterrshow</code>，上面有它的输出，配合statsclear会得到一定时间范围内所有端口错误统计信息：</p>
<p><strong>Frame(tx/rx)：</strong> tx代表端口发送的数据帧，rx代表端口收到的数据帧。</p>
<p><strong>Enc_in：</strong> 8b/10b或者64b/6bb数据帧帧内编码错误。在正常情况下20分钟会出现一次这个报错，交换机端口（offline/online）会产生这个错误。</p>
<p><strong>Crc_err：</strong> 数据帧CRC校验错误。根据实际统计，如果crc_err和enc_out同时出现，通常代表GBIC/SFP有硬件问题。</p>
<p><strong>Crc_g_eof：</strong> 数据帧CRC校验错误，但是数据帧EOF是正常的。</p>
<p><strong>Too_long：</strong> 数据帧总长度超过2148字节或者workload长度超过2112字节。</p>
<p><strong>Too_short：</strong> 小于36个字节长度的帧（workload字节长度等于0）。</p>
<p><strong>Bad_eof：</strong> 数据帧EOF错误。</p>
<p><strong>Enc_out：</strong> 8b/10b或者64b/66b数据帧帧外编码错误。在正常情况下20分钟会出现一次这个报错，交换机端口（offline/online）会产生这个报错，另外在HBA卡和交换机端口速率不同，而又使用的是静态配置端口速率的时候也会产生这个错误。单一的这个报错反映光纤线可能有问题；如果是Enc_out和crc_err同时报错代表GBIC/SFP有硬件问题。</p>
<p><strong>Disc c3：</strong> Class 3被交换机丢弃的数据帧。常见情形帧的目标地址不可达或者源端口还没有FLOGI交换机。这个参数仅仅代表有丢包发生，不能用来判定问题的具体原因。</p>
<p><strong>Link-fail：</strong> 当交换机端口在LR Receive State时间超过R_A_TOV就会产生这个错误。这个错误经常和loss of signal或者loss of sync同时出现。</p>
<p><strong>Loss sync：</strong> bit或者transmission-word synchronization失败都会产生这个错误。当交换机端口（offline/online）会产生这个问题。</p>
<p><strong>Loss sig：</strong> 链路收不到信号。当交换机端口（offline/online）会产生这个问题。</p>
<p><strong>Frjt：</strong> 用于class 2。代表数据帧无法处理。</p>
<p><strong>Frbsy：</strong> 用于class 2。数据帧无法在E_D_TOV时间内传输出去，超时后会产生这个问题。</p>
<p>一般情况下：<br>
如果仅是&quot;enc out &ldquo;单独报错主要是因为光纤线的问题。<br>
如果是&quot;enc out&quot;和&quot;crc err&quot;组合报错主要是GBIC/SFP的问题。</p>
<p>要确定是源端还是目标端SFP报错，需要再检查&quot;portshow x&rdquo; 的输出（x代表有问题端口号） 如果下面两对参数 &ldquo;Lr_in &quot; 和 &ldquo;Ols_out &quot; 以及 &ldquo;Lr_out &quot; 和&quot;Ols_in &quot; 的值相同，则表明SFP运行正常如果一个数值明显高于另一个, 连接问题可能出现在交换机连接的对端(&ldquo;in&rdquo; &gt; &ldquo;out&rdquo;) 或是交换机本身(&ldquo;out&rdquo; &gt; &ldquo;in&rdquo;).</p>
<p>如果”Ols_in”的值高于“Lr_out”的值，问题的根源大多数情况与连接的设备相关，(sending those offline sequences) 并且交换机通过&quot;link reset&quot;对此做出响应。</p>
<p>Loss sync，Loss sig，Link-fail这三个错误在链路初始化的过程中都会产生。当链路不稳定时候，通常这些错误计数器比较高。</p>
<p>Frjt，Frbsy用于class 2。SAN存储通常使用的是class 3，所以这两个错误很少见。</p>
<p>Enc_out和Crc_err两个计数器同时比较高，通常需要更换GBIC/SFP。</p>
<p>Disk c3只能代表链路有丢包现象。原因可能有很多种，具体问题具体分析。如果这个值过高，链路性能可能会受到影响。</p>

    
        <div class="pb-14 taxonomy-list tags-list text-gray-600 text-sm font-medium">
            
                    <a class="bg-gray-100 py-2 px-3 rounded-lg" href="/tags/3par/" alt="3PAR" >
                        3PAR
                    </a>
            
                    <a class="bg-gray-100 py-2 px-3 rounded-lg" href="/tags/brocade/" alt="Brocade" >
                        Brocade
                    </a>
            
        </div>


    </section>
    
    
    
        <div class="giscus-comment">
    <script
      src="https://giscus.app/client.js"
      data-repo="suikaremilia/suikaremilia.github.io"
      data-repo-id="R_kgDOHZJINw"
      data-category="Announcements"
      data-category-id="DIC_kwDOHZJIN84CYPk_"
      data-mapping="pathname"
      data-strict="0"
      data-reactions-enabled="1"
      data-emit-metadata="0"
      data-input-position="top"
      data-theme="light"
      data-lang="zh-CN"
      
        data-loading="lazy"
      
      crossorigin="anonymous"
      async
    ></script>
</div>
    

    
    

    <footer>

    </footer>
</article>

        </div><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1 ">
    © 2023 — <a class="hover:text-gray-500" href="https://suikaremilia.github.io/">Long life, short world, trading of time, long strangle, hedging bets</a> <span class=" font-normal ">
</div>
    <div class="text-xs font-semibold text-gray-500 order-1 sm:order-2">
    <ul class="flex sm:justify-end gap-5">
    <li><a class="hover:text-gray-500" href="https://t.me/touhoumichong" target="_blank" rel="noopener noreferrer">Telegram</a></li><li><a class="hover:text-gray-500" href="mailto:suika@kadama.eu.org" target="_blank" rel="noopener noreferrer">Mail</a></li><li><a class="hover:text-gray-500" href="/index.xml" target="_blank" rel="noopener noreferrer">RSS</a></li>
    </ul>
</div>
</footer></body>
</html>
