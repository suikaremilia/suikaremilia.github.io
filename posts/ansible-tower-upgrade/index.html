<!DOCTYPE html>
<html lang="en-us" class="scroll-smooth">
    <head><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ansible tower升级</title>
<meta name="description" content="升级是一种常态">
<link rel="canonical" href="https://suikaremilia.github.io/posts/ansible-tower-upgrade/">
<link rel="robots" href="/robots.txt" />
<link rel="stylesheet" href="https://suikaremilia.github.io/css/main.min.df1b948651de2b50af2bded0966d2d08b2a7217f36cbc0e2aaaaa9a7d2a94144.css" integrity="sha256-3xuUhlHeK1CvK97Qlm0tCLKnIX82y8Diqqqpp9KpQUQ=">
</head>
    <body class="max-w-screen-md px-10 mx-auto"><header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
    

<figure class="flex-none w-20 h-20 rounded-full overflow-hidden" ><a href="https://suikaremilia.github.io/"><img srcset="/img/firefox_hub66cb162f84e73856336c19b5d2d497e_36921_80x80_fill_q90_box_smart1.jpg 80w" src="/img/firefox.jpg" width="640" height="640" alt="Red Panda YOLO"></a></figure>

    <div class="flex flex-col gap-5">
    <a href="https://suikaremilia.github.io/">
    
    <h3 class="text-center sm:text-left text-4xl font-extrabold text-gray-800 ">Red Panda YOLO</h3>
    
</a>
    <nav>
    <ul class="flex flex-wrap justify-center uppercase text-xs font-semibold gap-7 text-gray-500 ">
        
        
        <li class="hover:text-gray-500"><a href="/">Home</a></li>
        
        <li class="hover:text-gray-500"><a href="/posts">Posts</a></li>
        
        <li class="hover:text-gray-500"><a href="/murmur">Ｍurmur</a></li>
        
        <li class="hover:text-gray-500"><a href="/tags">Tags</a></li>
        
    </ul>
</nav>
    </div>
</header><div id="content">
<article class="flex flex-col gap-10">
    <header class="flex flex-col gap-2">
        <h2 class="text-4xl leading-snug font-bold text-gray-900">ansible tower升级</h2>

        <div class="text-sm font-semibold text-gray-500 flex gap-3">
        
<time datetime="2020-07-27 17:39:01 &#43;0000 UTC" title="2020-07-27 17:39:01 &#43;0000 UTC">
    27 July 2020
</time>
        
        —
        
            <a class="hover:text-gray-500" href="/categories/tech/" alt="Tech" >
                Tech
                </a>
        

        </div>
    </header>
    <section class="content text-lg text-gray-800">
    <p>Ansible Tower的版本更新的也是莫名的快，去年安装的3.5今年已经到3.7.1了，新的版本可以在线申请license，旧的license快过期了，所以就升个级吧。</p>
<h2 id="步骤">步骤：</h2>
<p>升级的时候不能只看升级文档，还要看新版本的support，一开始只看了升级文档，做的时候报操作系统版本不被支持，所以第一步配个较新的rhel源，然后update系统。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#080;font-style:italic"># yum update -y</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"># systemctl reboot </span>
</span></span></code></pre></div><p>下载要升级的版本，并解压：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#080;font-style:italic"># wget https://releases.ansible.com/ansible-tower/setup/ansible-tower-setup-3.7.1-1.tar.gz</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"># tar xvzf ansible-tower-setup-3.7.1-1.tar.gz</span>
</span></span></code></pre></div><p>把曾经3.5时候安装的inventory拷贝一份到3.7,注意要把老版本的rabbitmq_host有关的变量更改为routable_hostname，因为新版本移除了rabbitmq：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#080;font-style:italic"># cp ansible-tower-bundle-3.5.1-1.el7/inventory ansible-tower-setup-3.7.1-1/</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"># cat inventory</span>
</span></span><span style="display:flex;"><span><span style="color:#666">[</span>tower<span style="color:#666">]</span>
</span></span><span style="display:flex;"><span>ansible01-ap
</span></span><span style="display:flex;"><span>ansible02-ap
</span></span><span style="display:flex;"><span><span style="color:#666">[</span>database<span style="color:#666">]</span>
</span></span><span style="display:flex;"><span><span style="color:#666">[</span>all:vars<span style="color:#666">]</span>
</span></span><span style="display:flex;"><span><span style="color:#b8860b">admin_password</span><span style="color:#666">=</span><span style="color:#b44">&#39;redhat&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#b8860b">pg_host</span><span style="color:#666">=</span><span style="color:#b44">&#39;10.xx.xx.xx&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#b8860b">pg_port</span><span style="color:#666">=</span><span style="color:#b44">&#39;5432&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#b8860b">pg_database</span><span style="color:#666">=</span><span style="color:#b44">&#39;towerdata&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#b8860b">pg_username</span><span style="color:#666">=</span><span style="color:#b44">&#39;postgres&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#b8860b">pg_password</span><span style="color:#666">=</span><span style="color:#b44">&#39;redhat&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#b8860b">routable_username</span><span style="color:#666">=</span><span style="color:#b44">&#39;tower&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#b8860b">routable_password</span><span style="color:#666">=</span><span style="color:#b44">&#39;redhat&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#b8860b">routable_cookie</span><span style="color:#666">=</span>cookiemonster
</span></span></code></pre></div><p>因为涉及到clust所以用到了rhscl里的两个包，可以单独下下来建一个源，也可以直接陪rhscl的源，我enable了base和rhcsl两个源。
然后，在各节点上关闭服务：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ansible tower -m command -a &#34;ansible-tower-service stop&#34; -i inventory
</span></span></code></pre></div><p>拆除主备实例关系：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># awx-manage list_instances
</span></span><span style="display:flex;"><span>[tower capacity=154]
</span></span><span style="display:flex;"><span>ansible01-ap capacity=72 version=3.5.1
</span></span><span style="display:flex;"><span>ansible02-ap capacity=72 version=3.5.1
</span></span><span style="display:flex;"><span># awx-manage deprovision_instance --hostname=ansible02-ap
</span></span><span style="display:flex;"><span># awx-manage list_instances
</span></span><span style="display:flex;"><span>[tower capacity=0]
</span></span><span style="display:flex;"><span>ansible01-ap capacity=0 version=3.5.1
</span></span></code></pre></div><p>最后就可以运行setup了：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># ./setup -i inventory
</span></span></code></pre></div><p>本来以为会很顺利，可是还是有点坑，不知道为什么ansible-tower的源通过proxy之后访问特别慢，而且还是总获取到ipv6的地址。所以找了一台可以连外网的机器，做了一个本地源：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#080;font-style:italic"># yum repolist</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"># yumdownloader --resolve --destdir /root/ansible ansible-tower</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"># createrepo -v -g /root/ansible-tower</span>
</span></span></code></pre></div><p>然而，这只是把tower相关的包下载下来做了一个本地镜像，实际运行setup的时候还是去找tower的源。
尝试用下面的命令同步整个源到本地，发现速度太慢了</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># reposync -l -p -m -g --download-metadata --repoid=ansible-tower --download_path=/root/ansible-tower
</span></span></code></pre></div><p>于是，翻了下playbook怎么写的，改了一下设置源的地方。有两个地方可以改，改一个就好了:
1、把源改成刚刚同步的最小的那个源的名：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat role/packages_el/defaults/main
</span></span><span style="display:flex;"><span>ansible_tower_repo: xxx
</span></span><span style="display:flex;"><span>ansible_tower_dependency_repo: xxx
</span></span></code></pre></div><p>2、把install_tower.yml里检查repo的部分去掉，要改两部分一个是ansible_tower_repo，一个是ansible_tower_dependency_repo，把相关这两个tasks注释掉就好了</p>
<p>最后，等待setup完成就得到一个新版本的ansible tower
检查一下服务状态及实例情况，一切正常：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#080;font-style:italic"># ansible-tower-service status</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"># awx-manage list_instances</span>
</span></span></code></pre></div><p>登录web，原来的project和inventory都在</p>
<h2 id="参考文档">参考文档：</h2>
<p><a href="https://docs.ansible.com/ansible-tower/3.7.1/html/installandreference/upgrade_tower.html#ir-upgrade-existing">https://docs.ansible.com/ansible-tower/3.7.1/html/installandreference/upgrade_tower.html#ir-upgrade-existing</a></p>

    
        <div class="pb-14 taxonomy-list tags-list text-gray-600 text-sm font-medium">
            
                    <a class="bg-gray-100 py-2 px-3 rounded-lg" href="/tags/ansible/" alt="Ansible" >
                        Ansible
                    </a>
            
        </div>


    </section>
    
    
    
        <div class="giscus-comment">
    <script
      src="https://giscus.app/client.js"
      data-repo="suikaremilia/suikaremilia.github.io"
      data-repo-id="R_kgDOHZJINw"
      data-category="Announcements"
      data-category-id="DIC_kwDOHZJIN84CYPk_"
      data-mapping="pathname"
      data-strict="0"
      data-reactions-enabled="1"
      data-emit-metadata="0"
      data-input-position="top"
      data-theme="light"
      data-lang="zh-CN"
      
        data-loading="lazy"
      
      crossorigin="anonymous"
      async
    ></script>
</div>
    

    
    

    <footer>

    </footer>
</article>

        </div><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1 ">
    © 2023 — <a class="hover:text-gray-500" href="https://suikaremilia.github.io/">Long life, short world, trading of time, long strangle, hedging bets</a> <span class=" font-normal ">
</div>
    <div class="text-xs font-semibold text-gray-500 order-1 sm:order-2">
    <ul class="flex sm:justify-end gap-5">
    <li><a class="hover:text-gray-500" href="https://t.me/touhoumichong" target="_blank" rel="noopener noreferrer">Telegram</a></li><li><a class="hover:text-gray-500" href="mailto:suika@kadama.eu.org" target="_blank" rel="noopener noreferrer">Mail</a></li><li><a class="hover:text-gray-500" href="/index.xml" target="_blank" rel="noopener noreferrer">RSS</a></li>
    </ul>
</div>
</footer></body>
</html>
