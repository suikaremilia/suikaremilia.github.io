<!doctype html>
<html lang="zh-cn">
  <head>
    <title>Opne Shift 4.6在线安装 // 小熊猫快站起来</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.115.4">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Suika" />
    <meta name="description" content="OCP是个好东西，除了贵" />
    <link rel="stylesheet" href="/css/main.min.f82e6642d2aa2ebd057ad3fab895ff231dd8f2c343218b39db0d271dc039bc4c.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Opne Shift 4.6在线安装"/>
<meta name="twitter:description" content="OCP是个好东西，除了贵"/>

    <meta property="og:title" content="Opne Shift 4.6在线安装" />
<meta property="og:description" content="OCP是个好东西，除了贵" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://suikaremilia.github.io/post/opneshift-46-install.md/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-12-12T09:14:40+00:00" />
<meta property="article:modified_time" content="2020-12-12T09:14:40+00:00" />


  </head>
  <body>
    <header class="app-header">
      <a href="https://suikaremilia.github.io/"><img class="app-header-avatar" src="/avatar.jpg" alt="Suika" /></a>
      <span class="app-header-title">小熊猫快站起来</span>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/">Home</a>
              ✰  
          
          <a class="app-header-menu-item" href="/tags/">Tags</a>
      </nav>
      <p>Long forex, Short the world.</p>
      <div class="app-header-social">
        
          <a href="https://t.me/Suikachat_bot" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-send">
  <title>telegram</title>
  <line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
</svg>
          </a>
        
          <a href="mailto:suika@kadama.eu.org" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-mail">
  <title>Mail</title>
  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline>
</svg>
          </a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Opne Shift 4.6在线安装</h1>
      <div class="post-meta">
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Dec 12, 2020
        </div>
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          8 min read
        </div>
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line>
</svg>
              <a class="tag" href="https://suikaremilia.github.io/tags/openshift/">Openshift</a>
        </div>
      </div>
    </header>
    <div class="post-content">
      <h2 id="规划">规划</h2>
<h3 id="架构">架构：</h3>
<h3 id="服务器信息">服务器信息：</h3>
<table>
<thead>
<tr>
<th>用途</th>
<th>主机名</th>
<th>IP</th>
</tr>
</thead>
<tbody>
<tr>
<td>Master1</td>
<td>ocpmaster01.suika.com</td>
<td>10.90.16.21</td>
</tr>
<tr>
<td>Work1</td>
<td>ocpwork01.suika.com</td>
<td>10.90.16.22</td>
</tr>
<tr>
<td>Work2</td>
<td>ocpwork02.suika.com</td>
<td>10.90.16.23</td>
</tr>
<tr>
<td>bootstrap</td>
<td>bootstrap.ocpsuika.com</td>
<td>10.90.18.19</td>
</tr>
<tr>
<td>bastion</td>
<td>bastion.suika.com</td>
<td>10.90.18.16</td>
</tr>
</tbody>
</table>
<h3 id="域名信息">域名信息：</h3>
<table>
<thead>
<tr>
<th>用途</th>
<th>域名</th>
<th>地址</th>
<th>端口</th>
</tr>
</thead>
<tbody>
<tr>
<td>Kubernetes API</td>
<td>api.ocp.suika.com</td>
<td>10.90.18.19</td>
<td>6443</td>
</tr>
<tr>
<td>Kubernetes API</td>
<td>api-int.suika.com</td>
<td>10.90.18.19</td>
<td>443</td>
</tr>
<tr>
<td>Routes</td>
<td>*.apps.suika.com</td>
<td>10.90.18.19</td>
<td>443</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>域名</th>
<th>IP</th>
<th>端口</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>console-openshift-console.apps.ocp.suika.com</td>
<td>10.90.16.21</td>
<td>443</td>
<td>OCP控制台页面</td>
</tr>
<tr>
<td>oauth-openshift.apps.ocp.suika.com</td>
<td>10.90.16.21</td>
<td>443</td>
<td>OCP oauth登录跳转页面</td>
</tr>
<tr>
<td>prometheus-k8s-openshift-monitoring.apps.ocp.suika.com</td>
<td>10.90.16.21</td>
<td>443</td>
<td>Prometheus</td>
</tr>
<tr>
<td>kibana-openshift-logging.apps.ocp.suika.com</td>
<td>10.90.16.21</td>
<td>443</td>
<td>Kibana</td>
</tr>
<tr>
<td>api.ocp.suika.com</td>
<td>10.90.16.21</td>
<td>6443</td>
<td>API</td>
</tr>
</tbody>
</table>
<h3 id="端口列表">端口列表：</h3>
<table>
<thead>
<tr>
<th>协议</th>
<th>端口</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>TCP</td>
<td>2379-2380</td>
<td>etcd server, peer, and metrics ports</td>
</tr>
<tr>
<td>TCP</td>
<td>6443</td>
<td>Kubernetes API</td>
</tr>
<tr>
<td>TCP</td>
<td>10249-10259</td>
<td>The default ports that Kubernetes reserves</td>
</tr>
<tr>
<td>TCP</td>
<td>10256</td>
<td>openshift-sdn</td>
</tr>
<tr>
<td>TCP</td>
<td>9000-9999</td>
<td>Host level services, including the node exporter on ports 9100-9101 and the Cluster Version Operator on port 9099.</td>
</tr>
<tr>
<td>UDP</td>
<td>4789、6081</td>
<td>VXLAN and GENEVE</td>
</tr>
<tr>
<td>UDP</td>
<td>9000-9999</td>
<td>Host level services, including the node exporter on ports 9100-9101.</td>
</tr>
<tr>
<td>TCP/UDP</td>
<td>30000-32767</td>
<td>Kubernetes NodePort</td>
</tr>
</tbody>
</table>
<h2 id="环境准备">环境准备：</h2>
<h3 id="离线资源">离线资源：</h3>
<p>pull secret <a href="https://cloud.redhat.com/openshift/install/metal/installer-provisioned">下载地址</a><br>
OpenShift CLI（OC）<a href="https://access.redhat.com/downloads/content/290/ver=4.6/rhel---8/4.6.3/x86_64/product-software">下载地址</a><br>
Openshift-install CLI <a href="https://access.redhat.com/downloads/content/290/ver=4.6/rhel---8/4.6.3/x86_64/product-software">下载地址</a><br>
CoreOS image <a href="https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/4.6/4.6.1/">下载地址</a></p>
<h3 id="安装openshift-cli并创建目录">安装OpenShift CLI并创建目录：</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># tar xvzf oc-4.6.3-linux.tar.gz</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># tar xvzf openshift-install-linux-4.6.3.tar.gz</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># mv oc kubectl openshift-install /usr/local/bin</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># mkdir -p /opt/install</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># touch /opt/install/install-config.yaml</span>
</span></span></code></pre></div><h3 id="dns配置">DNS配置：</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@bastion ~<span style="color:#f92672">]</span><span style="color:#75715e"># yum install dnsmasq -y</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@bastion ~<span style="color:#f92672">]</span><span style="color:#75715e"># cat /etc/dnsmasq.d/ocp.conf </span>
</span></span><span style="display:flex;"><span>address<span style="color:#f92672">=</span>/bastion.suika.com/10.90.18.16
</span></span><span style="display:flex;"><span>address<span style="color:#f92672">=</span>/api.ocp.suika.com/10.90.18.16
</span></span><span style="display:flex;"><span>address<span style="color:#f92672">=</span>/.apps.ocp.suika.com/10.90.18.16
</span></span><span style="display:flex;"><span>address<span style="color:#f92672">=</span>/api-int.ocp.suika.com/10.90.18.16
</span></span><span style="display:flex;"><span>address<span style="color:#f92672">=</span>/ocpmaster01.ocp.suika.com/10.90.16.21
</span></span><span style="display:flex;"><span>address<span style="color:#f92672">=</span>/ocpmaster02.ocp.suika.com/10.90.16.22
</span></span><span style="display:flex;"><span>address<span style="color:#f92672">=</span>/ocpmaster03.ocp.suika.com/10.90.16.23
</span></span><span style="display:flex;"><span>address<span style="color:#f92672">=</span>/bootstrap.ocp.suika.com/10.19.18.19
</span></span><span style="display:flex;"><span>address<span style="color:#f92672">=</span>/registry.suika.com/10.90.18.9
</span></span><span style="display:flex;"><span>address<span style="color:#f92672">=</span>/oauth-openshift.ocp.suika.com/10.90.18.16
</span></span><span style="display:flex;"><span>ptr-record<span style="color:#f92672">=</span>21.16.90.10.in-addr.arpa,ocpmaster01.ocp.suika.com
</span></span><span style="display:flex;"><span>ptr-record<span style="color:#f92672">=</span>22.16.90.10.in-addr.arpa,ocpmaster02.ocp.suika.com
</span></span><span style="display:flex;"><span>ptr-record<span style="color:#f92672">=</span>23.16.90.10.in-addr.arpa,ocpmaster03.ocp.suika.com
</span></span><span style="display:flex;"><span>ptr-record<span style="color:#f92672">=</span>19.18.90.10.in-addr.arpa,bootstrap.ocp.suika.com
</span></span><span style="display:flex;"><span>srv-host<span style="color:#f92672">=</span>_etcd-server-ssl._tcp.ocp.suika.com,etcd-0.ocp.suika.com,2380,10
</span></span><span style="display:flex;"><span>srv-host<span style="color:#f92672">=</span>_etcd-server-ssl._tcp.ocp.suika.com,etcd-1.ocp.suika.com,2380,10
</span></span><span style="display:flex;"><span>srv-host<span style="color:#f92672">=</span>_etcd-server-ssl._tcp.ocp.suika.com,etcd-2.ocp.suika.com,2380,10
</span></span></code></pre></div><p>启动服务：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@bastion ~<span style="color:#f92672">]</span><span style="color:#75715e"># systemctl start dnsmasq.service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@bastion ~<span style="color:#f92672">]</span><span style="color:#75715e"># systemctl status dnsmasq.service </span>
</span></span><span style="display:flex;"><span>● dnsmasq.service - DNS caching server.
</span></span><span style="display:flex;"><span>   Loaded: loaded <span style="color:#f92672">(</span>/usr/lib/systemd/system/dnsmasq.service; enabled; vendor preset: disabled<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>   Active: active <span style="color:#f92672">(</span>running<span style="color:#f92672">)</span> since Fri 2020-12-11 23:03:19 CST; <span style="color:#ae81ff">2</span> weeks <span style="color:#ae81ff">3</span> days ago
</span></span><span style="display:flex;"><span> Main PID: <span style="color:#ae81ff">46638</span> <span style="color:#f92672">(</span>dnsmasq<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>   CGroup: /system.slice/dnsmasq.service
</span></span><span style="display:flex;"><span>           └─46638 /usr/sbin/dnsmasq -k
</span></span></code></pre></div><h3 id="配置haproxy">配置haproxy：</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@bastion ~<span style="color:#f92672">]</span><span style="color:#75715e"># yum install haproxy -y</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@bastion ~<span style="color:#f92672">]</span><span style="color:#75715e"># vim /etc/haproxy/haproxy.cfg</span>
</span></span><span style="display:flex;"><span>global
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    log         127.0.0.1 local2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    chroot      /var/lib/haproxy
</span></span><span style="display:flex;"><span>    pidfile     /var/run/haproxy.pid
</span></span><span style="display:flex;"><span>    maxconn     <span style="color:#ae81ff">4000</span>
</span></span><span style="display:flex;"><span>    user        haproxy
</span></span><span style="display:flex;"><span>    group       haproxy
</span></span><span style="display:flex;"><span>    daemon
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># turn on stats unix socket</span>
</span></span><span style="display:flex;"><span>    stats socket /var/lib/haproxy/stats
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#---------------------------------------------------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># common defaults that all the &#39;listen&#39; and &#39;backend&#39; sections will</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># use if not designated in their block</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#---------------------------------------------------------------------</span>
</span></span><span style="display:flex;"><span>defaults
</span></span><span style="display:flex;"><span>    mode                    http
</span></span><span style="display:flex;"><span>    log                     global
</span></span><span style="display:flex;"><span>    option                  httplog
</span></span><span style="display:flex;"><span>    option                  dontlognull
</span></span><span style="display:flex;"><span>    option http-server-close
</span></span><span style="display:flex;"><span>    option forwardfor       except 127.0.0.0/8
</span></span><span style="display:flex;"><span>    option                  redispatch
</span></span><span style="display:flex;"><span>    retries                 <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>    timeout http-request    10s
</span></span><span style="display:flex;"><span>    timeout queue           1m
</span></span><span style="display:flex;"><span>    timeout connect         10s
</span></span><span style="display:flex;"><span>    timeout client          1m
</span></span><span style="display:flex;"><span>    timeout server          1m
</span></span><span style="display:flex;"><span>    timeout http-keep-alive 10s
</span></span><span style="display:flex;"><span>    timeout check           10s
</span></span><span style="display:flex;"><span>    maxconn                 <span style="color:#ae81ff">3000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>listen stats
</span></span><span style="display:flex;"><span>    bind :9000
</span></span><span style="display:flex;"><span>    mode http
</span></span><span style="display:flex;"><span>    stats enable
</span></span><span style="display:flex;"><span>    stats uri /
</span></span><span style="display:flex;"><span>    monitor-uri /healthz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>frontend openshift-api-server
</span></span><span style="display:flex;"><span>    bind *:6443
</span></span><span style="display:flex;"><span>    default_backend openshift-api-server
</span></span><span style="display:flex;"><span>    mode tcp
</span></span><span style="display:flex;"><span>    option tcplog
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>backend openshift-api-server
</span></span><span style="display:flex;"><span>    balance source
</span></span><span style="display:flex;"><span>    mode tcp
</span></span><span style="display:flex;"><span>    server bootstrap 10.90.18.19:6443 check
</span></span><span style="display:flex;"><span>    server master-0 10.90.16.21:6443 check
</span></span><span style="display:flex;"><span>    server master-1 10.90.16.22:6443 check
</span></span><span style="display:flex;"><span>    server master-2 10.90.16.23:6443 check
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>frontend machine-config-server
</span></span><span style="display:flex;"><span>    bind *:22623
</span></span><span style="display:flex;"><span>    default_backend machine-config-server
</span></span><span style="display:flex;"><span>    mode tcp
</span></span><span style="display:flex;"><span>    option tcplog
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>backend machine-config-server
</span></span><span style="display:flex;"><span>    balance source
</span></span><span style="display:flex;"><span>    mode tcp
</span></span><span style="display:flex;"><span>    server bootstrap 10.90.18.19:22623 check
</span></span><span style="display:flex;"><span>    server master-0 10.90.16.21:22623 check
</span></span><span style="display:flex;"><span>    server master-0 10.90.16.22:22623 check
</span></span><span style="display:flex;"><span>    server master-0 10.90.16.23:22623 check
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>frontend ingress-http
</span></span><span style="display:flex;"><span>    bind *:80
</span></span><span style="display:flex;"><span>    default_backend ingress-http
</span></span><span style="display:flex;"><span>    mode tcp
</span></span><span style="display:flex;"><span>    option tcplog
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>backend ingress-http
</span></span><span style="display:flex;"><span>    balance source
</span></span><span style="display:flex;"><span>    mode tcp
</span></span><span style="display:flex;"><span>    server worker-1 10.90.16.22:80 check
</span></span><span style="display:flex;"><span>    server worker-2 10.90.16.23:80 check
</span></span><span style="display:flex;"><span>    server worker-3 10.90.16.21:80 check
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>frontend ingress-https
</span></span><span style="display:flex;"><span>    bind *:443
</span></span><span style="display:flex;"><span>    default_backend ingress-https
</span></span><span style="display:flex;"><span>    mode tcp
</span></span><span style="display:flex;"><span>    option tcplog
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>backend ingress-https
</span></span><span style="display:flex;"><span>    balance source
</span></span><span style="display:flex;"><span>    mode tcp
</span></span><span style="display:flex;"><span>    server worker-1 10.90.16.22:443 check
</span></span><span style="display:flex;"><span>    server worker-2 10.90.16.23:443 check
</span></span><span style="display:flex;"><span>    server worker-3 10.90.16.21:443 check
</span></span><span style="display:flex;"><span>	
</span></span></code></pre></div><p>查看服务状态：</p>
<pre tabindex="0"><code>[root@bastion ~]# systemctl start haproxy.service

[root@bastion ~]# systemctl status haproxy.service 
● haproxy.service - HAProxy Load Balancer
   Loaded: loaded (/usr/lib/systemd/system/haproxy.service; enabled; vendor preset: disabled)
   Active: active (running) since Fri 2020-12-11 22:55:58 CST; 2 weeks 3 days ago
 Main PID: 46295 (haproxy-systemd)
   CGroup: /system.slice/haproxy.service
           ├─46295 /usr/sbin/haproxy-systemd-wrapper -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid
           ├─46296 /usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid -Ds
           └─46297 /usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid -Ds
</code></pre><h3 id="配置http服务器">配置http服务器：</h3>
<pre tabindex="0"><code>[root@bastion ~]# yum install httpd -y
[root@bastion ~]# mkdir -p /var/www/html/install/
[root@bastion ~]# ln -s /opt/install/ /var/www/html/install
</code></pre><p>同样启动服务并检查状态：</p>
<pre tabindex="0"><code>[root@bastion ~]# systemctl start httpd.service；systemctl status httpd.service
</code></pre><h2 id="安装过程">安装过程：</h2>
<h3 id="生成密钥待用">生成密钥待用：</h3>
<pre tabindex="0"><code> ssh-keygen -t rsa -b 2048 -N &#34;&#34; -f /root/.ssh/id_rsa ；cat /root/.ssh/id_rsa.pub 
</code></pre><h3 id="编辑install文件">编辑install文件：</h3>
<p>把下载的pull-secret.txt及上面的文件加到默认的install-config.yaml后面，并且配置proxy<br>
注意：noproxy中按“，”分隔</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>[<span style="color:#ae81ff">root@bastion ~]# cat /opt/install-config.yaml </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">baseDomain</span>: <span style="color:#ae81ff">suika.com </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">proxy</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">httpProxy</span>: <span style="color:#ae81ff">http://suika:suika@proxy@suika.com:8080 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">noProxy</span>: <span style="color:#ae81ff">.suika.com,.suika.com,.ocp.suika.com,10.90.16.0/22</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">compute</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">hyperthreading</span>: <span style="color:#ae81ff">Enabled   </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">worker</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">0</span> 
</span></span><span style="display:flex;"><span><span style="color:#f92672">controlPlane</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hyperthreading</span>: <span style="color:#ae81ff">Enabled   </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">master </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ocp</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">networking</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">clusterNetwork</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">cidr</span>: <span style="color:#ae81ff">10.128.0.0</span><span style="color:#ae81ff">/14 </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostPrefix</span>: <span style="color:#ae81ff">23</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">networkType</span>: <span style="color:#ae81ff">OpenShiftSDN</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">serviceNetwork</span>: 
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">172.30.0.0</span><span style="color:#ae81ff">/16</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">platform</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">none</span>: {} 
</span></span><span style="display:flex;"><span><span style="color:#f92672">fips</span>: <span style="color:#66d9ef">false</span> 
</span></span><span style="display:flex;"><span><span style="color:#f92672">pullSecret</span>: <span style="color:#e6db74">&#39;{&#34;auths&#34;:{&#34;cloud.openshift.com&#34;:{&#34;auth&#34;:&#34;b3BlbnNoaWZ0LXJlbGVhc2UtZGV2K2N1aXNvbmd0YW9oM2Njb20xdnY2YjdzZ3FodWxyYjBiYXhucThxbW51b2s6WUYyQ1I1UTNNV1NFU1dLVVNEME8zNUo4UkVRUjI3QVBURDVIUkVWRVpEUExRSUJFOE85U0dFWE81QlRQNVo2VQ==&#34;,&#34;email&#34;:&#34;suika@suika.com&#34;},&#34;quay.io&#34;:{&#34;auth&#34;:&#34;b3BlbnNoaWZ0LXJlbGVhc2UtZGV2K2N1aXNvbmd0YW9oM2Njb20xdnY2YjdzZ3FodWxyYjBiYXhucThxbW51b2s6WUYyQ1I1UTNNV1NFU1dLVVNEME8zNUo4UkVRUjI3QVBURDVIUkVWRVpEUExRSUJFOE85U0dFWE81QlRQNVo2VQ==&#34;,&#34;email&#34;:&#34;suika@suika.com&#34;},&#34;registry.connect.redhat.com&#34;:{&#34;auth&#34;:&#34;NzYxMDE1Mnx1aGMtMVZWNmI3c0dxaFVMcmIwYkF4blE4cU1OVU9LOmV5SmhiR2NpT2lKU1V6VXhNaUo5LmV5SnpkV0lpT2lJMU1tWTROR05tWm1Nd01EQTBOelV5WVdVNU16WmxaVGhrTkROaFlUbGhNeUo5LlJiT1g3Ml9qY21fVTZLSFdVMS1VT19YTUk0aXVuSXZ3SVRWa1dsUDZ2QlU0Qzl0U2pickltM1FuY2Q4WENjeUVoQWY5cUoxVXRtWHlVWk5JODZ3dEo1eVE1STZnU3FlZ2RBMEZ2ek1tQk9qUzZ6eHAxVm83ZmNfVG1oYzBQSERhSWVudlhTZ3BscnNaUWpRckllVUNlUlNuaGRGdDFSdHU0djFaMDh1V1N4Y3k4VGI0dXIyNmRXZWhUSUF6Q0R2aFNkRzBhUVZaRExOYVd5QTE2YjIwSEdFYVNRNmlXUDNQZ05tUWFmTkdyUnNOTFZYd01Qd0ZQU01YMkdsVGhmMXludEpiTXl3UEx1a3pzaEozeFJ3bkFFV0JIdGd2dVlDNUN2YjB1SFlUMDJWVUV1Q21hbDBBQkppUlo4LVdiOV9RZEgxcXNKQzBGRGFUa2dhSjhzSWpleE9qTWtRWVZCeHI4OGpNNVcta0xlbmhLQmRxMTladHFiWTdwMGd0S0JjWjFQczlkSWJRRzJKSTVUZEZza2suika1VDeHdYM1o2QVlBeGJyR2ItSHVBRi1PT0pTdVBKU3RNMDJPblBHdGVRaUVSd0ZOMUZNZjEwRmxjQktlRTIyUGR1SU1sN3gyWTIxalJMR3VZdHBZa0FWVUZ1UEdMM3l3ZVFsWGk4RWYxVG9FV2kwU0dpWXFaNEt1ZWNLVjhUWFhWNHJCUTJSNHhZQmVwZ1F5d2xPNWdiU0xNQ0IwNzkxUlAtRXFyUlNadkJhbERjSlRfbzNxNlk5VWYtYnRuaVBjeTY0bkIxUHZmakxwazNqY0tBdWtBVHZDZjhrUmJKRVkwOFVWQXVpZENadFZiZDByWXpXNS1TUDN3VC10ZGhTb2h5OWNvZ2xTWkZ6aXhlYmJFdkNmalBJ&#34;,&#34;email&#34;:&#34;suika@suika.com&#34;},&#34;registry.redhat.io&#34;:{&#34;auth&#34;:&#34;NzYxMDE1Mnx1aGMtMVZWNmI3c0dxaFVMcmIwYkF4blE4cU1OVU9LOmV5SmhiR2NpT2lKU1V6VXhNaUo5LmV5SnpkV0lpT2lJMU1tWTROR05tWm1Nd01EQTBOelV5WVdVNU16WmxaVGhrTkROaFlUbGhNeUo5LlJiT1g3Ml9qY21fVTZLSFdVMS1VT19YTUk0aXVuSXZ3SVRWa1dsUDZ2QlU0Qzl0U2pickltM1FuY2Q4WENjeUVoQWY5cUoxVXRtWHlVWk5JODZ3dEo1eVE1STZnU3FlZ2RBMEZ2ek1tQk9qUzZ6eHAxVm83ZmNfVG1oYzBQSERhSWVudlhTZ3BscnNaUWpRckllVUNlUlNuaGRGdDFSdHU0djFaMDh1V1N4Y3k4VGI0dXIyNmRXZWhUSUF6Q0R2aFNkRzBhUVZaRExOYVd5QTE2YjIwSEdFYVNRNmlXUDNQZ05tUWFmTkdyUnNOTFZYd01Qd0ZQU01YMkdsVGhmMXludEpiTXl3UEx1a3pzaEozeFJ3bkFFV0JIdGd2dVlDNUN2YjB1SFlUMDJWVUV1Q21hbDBBQkppUlo4LVdiOV9RZEgxcXNKQzBGRGFUa2dhSjhzSWpleE9qTWtRWVZCeHI4OGpNNVcta0xlbmhLQmRxMTladHFiWTdwMGd0S0JjWjFQczlkSWJRRzJKSTVUZEZza2suika1VDeHdYM1o2QVlBeGJyR2ItSHVBRi1PT0pTdVBKU3RNMDJPblBHdGVRaUVSd0ZOMUZNZjEwRmxjQktlRTIyUGR1SU1sN3gyWTIxalJMR3VZdHBZa0FWVUZ1UEdMM3l3ZVFsWGk4RWYxVG9FV2kwU0dpWXFaNEt1ZWNLVjhUWFhWNHJCUTJSNHhZQmVwZ1F5d2xPNWdiU0xNQ0IwNzkxUlAtRXFyUlNadkJhbERjSlRfbzNxNlk5VWYtYnRuaVBjeTY0bkIxUHZmakxwazNqY0tBdWtBVHZDZjhrUmJKRVkwOFVWQXVpZENadFZiZDByWXpXNS1TUDN3VC10ZGhTb2h5OWNvZ2xTWkZ6aXhlYmJFdkNmalBJ&#34;,&#34;email&#34;:&#34;suika@suika.com&#34;}}}&#39;</span> 
</span></span><span style="display:flex;"><span><span style="color:#f92672">sshKey</span>: <span style="color:#e6db74">&#39;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDnfEBthXuNhuE/3dnGHEfzB9I2aYVmJUMe25sxL9BsX02tj+OA4H30j30tB4hD+AWrP3PEnt8zdD25ggGu1lGE4Ckt38uhMYud/a+amr5oTcIfIYlj/f9mo8VwKzehx7K7G8JWnFXwPjln97MuM/QVg6S+DY2wvGCSG+6MFwrq4/OCBlu1qjyoaE6yMl510n3rOB1WrUcj/LCiHBTsCsytx4fmtbSLxUxMyl3nfA83zhATg+meHKFtLpIEGZbMib7diI8APcOlEX4lOOwqf0lI6bFfTy2pRJ2cLAJXLvQaJL4eOhTOMqzbquj3g+gzkqpMf2R9L/fDTP5pwQqIkJjd root@bastion&#39;</span> 
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">root@bastion ~]# cp /opt/install-config.yaml /opt/install/install-config.yaml </span>
</span></span></code></pre></div><h3 id="创建配置">创建配置：</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@bastion ~<span style="color:#f92672">]</span><span style="color:#75715e"># openshift-install create manifests --dir=/opt/install</span>
</span></span><span style="display:flex;"><span>INFO Consuming Install Config from target directory 
</span></span><span style="display:flex;"><span>WARNING Making control-plane schedulable by setting MastersSchedulable to true <span style="color:#66d9ef">for</span> Scheduler cluster settings 
</span></span><span style="display:flex;"><span>INFO Manifests created in: /opt/install/manifests and /opt/install/openshift 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@bastion ~<span style="color:#f92672">]</span><span style="color:#75715e"># openshift-install create ignition-configs --dir=/opt/install/</span>
</span></span><span style="display:flex;"><span>INFO Consuming Common Manifests from target directory 
</span></span><span style="display:flex;"><span>INFO Consuming Master Machines from target directory 
</span></span><span style="display:flex;"><span>INFO Consuming OpenShift Install <span style="color:#f92672">(</span>Manifests<span style="color:#f92672">)</span> from target directory 
</span></span><span style="display:flex;"><span>INFO Consuming Openshift Manifests from target directory 
</span></span><span style="display:flex;"><span>INFO Consuming Worker Machines from target directory 
</span></span><span style="display:flex;"><span>INFO Ignition-Configs created in: /opt/install and /opt/install/auth
</span></span></code></pre></div><p>现在的目录结构是这样：</p>
<pre tabindex="0"><code>[root@bastion ~]# tree /opt/install
/opt/install
├── auth
│   ├── kubeadmin-password
│   └── kubeconfig
├── bootstrap.ign
├── bootstrap.sh
├── master.ign
├── master.sh
├── metadata.json
└── worker.ign

1 directory, 8 files
</code></pre><h3 id="创建安装脚本">创建安装脚本：</h3>
<p>环境比较特殊，不能搭DHCP所以无法pxe安装，只能配置静态IP，又懒得改镜像，所以就琢磨出这么个办法安装。<br>
注意脚本中的<code>'rd.neednet=1'</code>否则启动的时候有可能主机名变为localhost</p>
<pre tabindex="0"><code>[root@bastion ~]# cat /var/www/html/install/bootstrap.sh
#!/bin/bash
/bin/coreos-installer install --copy-network --insecure-ignition --ignition-url=http://10.90.18.16:8080/install/bootstrap.ign --firstboot-args &#39;rd.neednet=1&#39; /dev/vda

[root@bastion ~]# cat /var/www/html/install/master.sh
#!/bin/bash
/bin/coreos-installer install --copy-network --insecure-ignition --ignition-url=http://10.90.18.16:8080/install/master.ign --firstboot-args &#39;rd.neednet=1&#39; /dev/sda
</code></pre><h3 id="启动设备">启动设备：</h3>
<p>打开设备电源并在ilo挂载rhcos镜像：<br>
<img src="1609291406688.png" alt=""><br>
<img src="1609291424913.png" alt=""><br>
<img src="1609291432187.png" alt=""><br>
用nmtui配置网络，生效后检查是否获取到主机名<br>
下载上面的安装脚本进行安装：<br>
<img src="1609291401163.png" alt=""></p>
<h3 id="重启设备进行安装">重启设备进行安装：</h3>
<p>安装完成后先重启bootstrap，待其重启完成后，并检查有pod后重启三台master主机。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>core@bootstrap ~<span style="color:#f92672">]</span>$ sudo crictl pods
</span></span><span style="display:flex;"><span>POD ID              CREATED              STATE               NAME                                                           NAMESPACE                             ATTEMPT
</span></span><span style="display:flex;"><span>519ca2107ede7       <span style="color:#ae81ff">33</span> seconds ago       Ready               bootstrap-kube-scheduler-bootstrap.ocp.suika.com             kube-system                           <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>ee3682d35720d       <span style="color:#ae81ff">33</span> seconds ago       Ready               bootstrap-kube-controller-manager-bootstrap.ocp.suika.com    kube-system                           <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>4832d0632a339       <span style="color:#ae81ff">33</span> seconds ago       Ready               bootstrap-kube-apiserver-bootstrap.ocp.suika.com             kube-system                           <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>1e6aa212b904d       <span style="color:#ae81ff">33</span> seconds ago       Ready               cloud-credential-operator-bootstrap.ocp.suika.com            openshift-cloud-credential-operator   <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>4fc5ec6c6e443       <span style="color:#ae81ff">33</span> seconds ago       Ready               bootstrap-cluster-version-operator-bootstrap.ocp.suika.com   openshift-cluster-version             <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>fee62b862de12       <span style="color:#ae81ff">50</span> seconds ago       Ready               bootstrap-machine-config-operator-bootstrap.ocp.suika.com    default                               <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>f7b83eedcfbc6       About a minute ago   Ready               etcd-bootstrap-member-bootstrap.ocp.suika.com                openshift-etcd                        <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>core@bootstrap ~<span style="color:#f92672">]</span>$ ss -tulnp|grep <span style="color:#ae81ff">6443</span>
</span></span><span style="display:flex;"><span>tcp     LISTEN   <span style="color:#ae81ff">0</span>        <span style="color:#ae81ff">128</span>                    *:6443                 *:*     
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>core@bootstrap ~<span style="color:#f92672">]</span>$ ss -tulnp|grep <span style="color:#ae81ff">22623</span>
</span></span><span style="display:flex;"><span>tcp     LISTEN   <span style="color:#ae81ff">0</span>        <span style="color:#ae81ff">128</span>                    *:22623                *:*   
</span></span></code></pre></div><p>重启master的时候需要盯着点ilo，启动完成后虽然可以获取到正确的主机名，但还是要把主机名修改一下，不然后面再重启主机名可能又变回localhost了。</p>
<pre tabindex="0"><code>[root@bastion ~]# ssh core@10.90.16.23
The authenticity of host &#39;10.90.16.23 (10.90.16.23)&#39; can&#39;t be established.
ECDSA key fingerprint is SHA256:9ZehCh3XkLlk86xu43DiSnIk8bT14UfPGc+dlxX6qzg.
ECDSA key fingerprint is MD5:a7:d7:2c:58:5d:8c:42:44:ec:fa:b0:b8:76:86:7f:14.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added &#39;10.90.16.23&#39; (ECDSA) to the list of known hosts.
Red Hat Enterprise Linux CoreOS 46.82.202010091720-0
  Part of OpenShift 4.6, RHCOS is a Kubernetes native operating system
  managed by the Machine Config Operator (`clusteroperator/machine-config`).

WARNING: Direct SSH access to machines is not recommended; instead,
make configuration changes via `machineconfig` objects:
  https://docs.openshift.com/container-platform/4.6/architecture/architecture-rhcos.html

---
[core@ocpmaster03 ~]$ hostname
ocpmaster03.ocp.suika.com
[core@ocpmaster03 ~]$ sudo hostnamectl set-hostname ocpmaster03.ocp.suika.com
</code></pre><h3 id="等待安装完成">等待安装完成：</h3>
<p>此后剩下的就是等待安装完成，大概要一杯咖啡的时间：</p>
<pre tabindex="0"><code>[root@bastion ~]# openshift-install --dir=/opt/install wait-for bootstrap-complete --log-level=debug
DEBUG OpenShift Installer 4.6.4                    
DEBUG Built from commit 6e02d049701437fa81521fe981405745a62c86c5 
INFO Waiting up to 20m0s for the Kubernetes API at https://api.ocp.suika.com:6443... 
INFO API v1.19.0+9f84db3 up                       
INFO Waiting up to 30m0s for bootstrapping to complete... 
</code></pre><p>至此可以移除bootstrap节点，并把haproxy中关于bootstrap的信息注释掉，并重启haproxy，然后继续等待安装完成：</p>
<pre tabindex="0"><code>[root@bastion ~]# oc get node
NAME                          STATUS   ROLES           AGE    VERSION
ocpmaster01.ocp.suika.com   Ready    master,worker   2m     v1.19.0+9f84db3
ocpmaster02.ocp.suika.com   Ready    master,worker   5m9s   v1.19.0+9f84db3
ocpmaster03.ocp.suika.com   Ready    master,worker   10m    v1.19.0+9f84db3
[root@bastion install]# openshift-install --dir=/opt/install wait-for install-complete --log-level debug
DEBUG OpenShift Installer 4.6.4                    
DEBUG Built from commit 6e02d049701437fa81521fe981405745a62c86c5 
DEBUG Loading Install Config...                    
DEBUG   Loading SSH Key...                         
DEBUG   Loading Base Domain...                     
DEBUG     Loading Platform...                      
DEBUG   Loading Cluster Name...                    
DEBUG     Loading Base Domain...                   
DEBUG     Loading Platform...                      
DEBUG   Loading Pull Secret...                     
DEBUG   Loading Platform...                        
DEBUG Using Install Config loaded from state file  
INFO Waiting up to 40m0s for the cluster at https://api.ocp.suika.com:6443 to initialize... 
DEBUG Cluster is initialized                       
INFO Waiting up to 10m0s for the openshift-console route to be created... 
DEBUG Route found in openshift-console namespace: console 
DEBUG Route found in openshift-console namespace: downloads 
DEBUG OpenShift console route is created           
INFO Install complete!                            
INFO To access the cluster as the system:admin user when using &#39;oc&#39;, run &#39;export KUBECONFIG=/opt/install/auth/kubeconfig&#39; 
INFO Access the OpenShift web-console here: https://console-openshift-console.apps.ocp.suika.com 
INFO Login to the console with user: &#34;kubeadmin&#34;, and password: &#34;XviuD-bnp8Y-RNYxL-zcp8R&#34; 
INFO Time elapsed: 0s  
</code></pre><p>注意这个输出的kubeadmin用户及其密码，后面console登录会用到</p>
<h2 id="安装后的工作">安装后的工作：</h2>
<p>到上面那个输出openshift就已经安装完成了，做一点额外的工作</p>
<h3 id="检查状态">检查状态：</h3>
<pre tabindex="0"><code>[root@bastion ~]# oc get co
NAME                                       VERSION   AVAILABLE   PROGRESSING   DEGRADED   SINCE
authentication                             4.6.4     True        False         False      90s
cloud-credential                           4.6.4     True        False         False      37m
cluster-autoscaler                         4.6.4     True        False         False      21m
config-operator                            4.6.4     True        False         False      22m
console                                    4.6.4     True        False         False      8m50s
csi-snapshot-controller                    4.6.4     True        False         False      22m
dns                                        4.6.4     True        False         False      20m
etcd                                       4.6.4     True        False         False      15m
image-registry                             4.6.4     True        False         False      12m
ingress                                    4.6.4     True        False         False      12m
insights                                   4.6.4     True        False         False      22m
kube-apiserver                             4.6.4     True        False         False      15m
kube-controller-manager                    4.6.4     True        False         False      20m
kube-scheduler                             4.6.4     True        False         False      16m
kube-storage-version-migrator              4.6.4     True        False         False      20m
machine-api                                4.6.4     True        False         False      21m
machine-approver                           4.6.4     True        False         False      21m
machine-config                             4.6.4     True        False         False      20m
marketplace                                4.6.4     True        False         False      20m
monitoring                                 4.6.4     True        False         False      10m
network                                    4.6.4     True        False         False      23m
node-tuning                                4.6.4     True        False         False      22m
openshift-apiserver                        4.6.4     True        False         False      11m
openshift-controller-manager               4.6.4     True        False         False      19m
openshift-samples                          4.6.4     True        False         False      12m
operator-lifecycle-manager                 4.6.4     True        False         False      21m
operator-lifecycle-manager-catalog         4.6.4     True        False         False      21m
operator-lifecycle-manager-packageserver   4.6.4     True        False         False      12m
service-ca                                 4.6.4     True        False         False      22m
storage                                    4.6.4     True        False         False      22m
</code></pre><h3 id="获取console地址">获取console地址：</h3>
<pre tabindex="0"><code>[root@bastion ~]# oc get route -A |grep openshift
openshift-authentication   oauth-openshift     oauth-openshift.apps.ocp.suika.com                                 oauth-openshift     6443       passthrough/Redirect   None
openshift-cnv              test-maven-app      test-maven-app-openshift-cnv.apps.ocp.suika.com                    test-maven-app      8080-tcp                          None
openshift-console          console             console-openshift-console.apps.ocp.suika.com                       console             https      reencrypt/Redirect     None
openshift-console          downloads           downloads-openshift-console.apps.ocp.suika.com                     downloads           http       edge/Redirect          None
openshift-monitoring       alertmanager-main   alertmanager-main-openshift-monitoring.apps.ocp.suika.com          alertmanager-main   web        reencrypt/Redirect     None
openshift-monitoring       grafana             grafana-openshift-monitoring.apps.ocp.suika.com                    grafana             https      reencrypt/Redirect     None
openshift-monitoring       prometheus-k8s      prometheus-k8s-openshift-monitoring.apps.ocp.suika.com             prometheus-k8s      web        reencrypt/Redirect     None
openshift-monitoring       thanos-querier      thanos-querier-openshift-monitoring.apps.ocp.suika.com             thanos-querier      web        reencrypt/Redirect     None
openshift                  nodejs-sample       nodejs-sample-openshift.apps.ocp.suika.com                         nodejs-sample       8080-tcp                          None
</code></pre><p>添加上面的域名解析到任意一个master或haproxy的虚地址，然后就可以用web登录了，用前面的kubeadmin用户及密码</p>
<h3 id="配置时钟同步服务">配置时钟同步服务：</h3>
<p>通过浏览器登录到open shift的console之后，就会发现一个告警，集群没有配置NTP服务，然而又翻了一遍安装文档还是没地方讲这玩意怎么配。<br>
找了一下红帽的官网，发现解决的办法有两个，一个就是在主机启动后尽快登录，然后配置ntp服务，就是在重启后修改主机名的时候一并修改了NTP，然而这是什么鬼方案，如果不是环境不允许谁没事盯着ilo看启动到哪一步了……<br>
合理的是采用第二种方案：<br>
1、创建base64格式的chrony.conf</p>
<pre tabindex="0"><code>cat &lt;&lt; EOF | base64 -w 0
server suikantp02-in.suika.com iburst
driftfile /var/lib/chrony/drift
makestep 1.0 3
rtcsync
logdir /var/log/chrony
EOF
</code></pre><p>2、创建99_masters-chrony-configuration.yaml文件，并写入上面的信息：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>[<span style="color:#ae81ff">root@bastion opt]# cat 99_masters-chrony-configuration.yaml </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">machineconfiguration.openshift.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">MachineConfig</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">machineconfiguration.openshift.io/role</span>: <span style="color:#ae81ff">master</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">masters-chrony-configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">config</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ignition</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">config</span>: {}
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">security</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">tls</span>: {}
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">timeouts</span>: {}
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">version</span>: <span style="color:#ae81ff">2.2.0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networkd</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">passwd</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">storage</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">files</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">contents</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">source</span>: <span style="color:#ae81ff">data:text/plain;charset=utf-8;base64,c2VydmVyIGgzY250cDAyLWluLmgzYy5jb20gaWJ1cnN0CmRyaWZ0ZmlsZSAvdmFyL2xpYi9jaHJvbnkvZHJpZnQKbWFrZXN0ZXAgMS4wIDMKcnRjc3luYwpsb2dkaXIgL3Zhci9sb2cvY2hyb255Cg==</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">verification</span>: {}
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">filesystem</span>: <span style="color:#ae81ff">root</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">mode</span>: <span style="color:#ae81ff">420</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/etc/chrony.conf</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">osImageURL</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span></code></pre></div><p>如果有worker节点创建一个类似的99_workers-chrony-configuration.yaml的文件。</p>
<p>3、应用文件：</p>
<pre tabindex="0"><code>oc apply -f 99_masters-chrony-configuration.yaml
</code></pre><p>等一会，登录到任意主机，检查一下chrony的状态已是修改后的状态：</p>
<pre tabindex="0"><code>[core@ocpmaster03 ~]$ cat /etc/chrony.conf 
server suikantp02-in.suika.com iburst
driftfile /var/lib/chrony/drift
makestep 1.0 3
rtcsync
logdir /var/log/chrony
[core@ocpmaster03 ~]$ timedatectl 
               Local time: Mon 2020-12-14 08:12:01 UTC
           Universal time: Mon 2020-12-14 08:12:01 UTC
                 RTC time: Mon 2020-12-14 08:12:01
                Time zone: UTC (UTC, +0000)
System clock synchronized: yes
              NTP service: active
          RTC in local TZ: no
</code></pre><p>至此，集群搭建完毕。</p>
<h2 id="参考文档">参考文档：</h2>
<p><a href="https://access.redhat.com/solutions/4906341">https://access.redhat.com/solutions/4906341</a><br>
<a href="https://misa.gitbook.io/k8s-ocp-yaml/openshift-docs/">https://misa.gitbook.io/k8s-ocp-yaml/openshift-docs/</a><br>
<a href="https://docs.openshift.com/container-platform/4.6/installing/installing_bare_metal/installing-bare-metal.html">https://docs.openshift.com/container-platform/4.6/installing/installing_bare_metal/installing-bare-metal.html</a></p>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
